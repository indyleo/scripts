#!/bin/env bash

best_battery_info=""
lowest_percent=101

while IFS= read -r line; do
    status=$(echo "$line" | awk -F': |, ' '{print $2}')
    percent_raw=$(echo "$line" | awk -F': |, ' '{print $3}')
    percent=${percent_raw%\%}

    # Skip batteries with unknown or bad data
    [[ $status == "Unknown" ]] && continue

    # Prefer discharging battery if multiple are valid
    if [[ $status == "Discharging" ]]; then
        best_battery_info="$line"
        break
    fi

    # Otherwise, pick the battery with the lowest percentage
    if (( percent < lowest_percent )); then
        best_battery_info="$line"
        lowest_percent=$percent
    fi
done <<< "$(acpi -b)"

# Extract final values
STATUS=$(echo "$best_battery_info" | awk -F': |, ' '{print $2}')
PERCENT_RAW=$(echo "$best_battery_info" | awk -F': |, ' '{print $3}')
PERCENT=${PERCENT_RAW%\%}

# Icon logic
case $STATUS in
    Charging)
        if [ $PERCENT -eq 100 ]; then STATUS_ICON="󰂅 "
        elif [ $PERCENT -ge 90 ]; then STATUS_ICON="󰂋 "
        elif [ $PERCENT -ge 80 ]; then STATUS_ICON="󰂊 "
        elif [ $PERCENT -ge 70 ]; then STATUS_ICON="󰢞 "
        elif [ $PERCENT -ge 60 ]; then STATUS_ICON="󰂉 "
        elif [ $PERCENT -ge 50 ]; then STATUS_ICON="󰢝 "
        elif [ $PERCENT -ge 40 ]; then STATUS_ICON="󰂈 "
        elif [ $PERCENT -ge 30 ]; then STATUS_ICON="󰂇 "
        elif [ $PERCENT -ge 20 ]; then STATUS_ICON="󰂆 "
        elif [ $PERCENT -ge 10 ]; then STATUS_ICON="󰢜 "
        else STATUS_ICON="󰢟 "
        fi
        ;;
    Discharging)
        if [ $PERCENT -eq 100 ]; then STATUS_ICON="󰁹 "
        elif [ $PERCENT -ge 90 ]; then STATUS_ICON="󰂂 "
        elif [ $PERCENT -ge 80 ]; then STATUS_ICON="󰂁 "
        elif [ $PERCENT -ge 70 ]; then STATUS_ICON="󰂀 "
        elif [ $PERCENT -ge 60 ]; then STATUS_ICON="󰁿 "
        elif [ $PERCENT -ge 50 ]; then STATUS_ICON="󰁾 "
        elif [ $PERCENT -ge 40 ]; then STATUS_ICON="󰁽 "
        elif [ $PERCENT -ge 30 ]; then STATUS_ICON="󰁼 "
        elif [ $PERCENT -ge 20 ]; then STATUS_ICON="󰁻 "
        elif [ $PERCENT -ge 10 ]; then STATUS_ICON="󰁺 "
        else STATUS_ICON="󰂎 "
        fi
        ;;
    Full)
        STATUS_ICON="󰂅 "
        ;;
    Not\ charging)
        if [ $PERCENT -eq 100 ]; then STATUS_ICON="󰂅 "
        elif [ $PERCENT -ge 90 ]; then STATUS_ICON="󰂋 "
        elif [ $PERCENT -ge 80 ]; then STATUS_ICON="󰂊 "
        elif [ $PERCENT -ge 70 ]; then STATUS_ICON="󰢞 "
        elif [ $PERCENT -ge 60 ]; then STATUS_ICON="󰂉 "
        elif [ $PERCENT -ge 50 ]; then STATUS_ICON="󰢝 "
        elif [ $PERCENT -ge 40 ]; then STATUS_ICON="󰂈 "
        elif [ $PERCENT -ge 30 ]; then STATUS_ICON="󰂇 "
        elif [ $PERCENT -ge 20 ]; then STATUS_ICON="󰂆 "
        elif [ $PERCENT -ge 10 ]; then STATUS_ICON="󰢜 "
        else STATUS_ICON="󰢟 "
        fi
        ;;
    *)
        STATUS_ICON="󰂃 "
        ;;
esac

echo "$STATUS_ICON $PERCENT_RAW"
