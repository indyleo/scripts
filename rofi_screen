#!/bin/env bash
# Screen Recording & Streaming Manager

# --- Ensure dependencies ---
for cmd in ffmpeg rofi notify-send xrandr; do
    if ! command -v $cmd &> /dev/null; then
        echo "Error: $cmd not found. Please install it first."
        exit 1
    fi
done

# --- Variables ---
FPS_REC=60
FPS_STREAM=30
STREAM_KEY="$TWITCH_TOKEN"  # Ensure exported
SERVER="ingest.global-contribute"
SIGNAL="21"

# --- Detect primary monitor ---
primary_info=$(xrandr | awk '/ primary / {print $4}')
RES=${primary_info%%+*}
offset=${primary_info#*+}
offset=${offset//+/,}
screen_width=${RES%x*}

# --- Functions ---

function record() {
    now="$(date '+%a__%b%d__%H_%M_%S')"
    outputloc="$HOME/Videos/video_${now}"
    mkdir -p "$outputloc"/{vid,aud}

    ffmpeg -video_size "$RES" -f x11grab -r "$FPS_REC" -i "$DISPLAY+${offset}" -c:v h264 -qp 0 \
        "${outputloc}/vid/video_${now}.mkv" &
    echo $! > /tmp/recpid

    ffmpeg -f pulse -i default -af "afftdn=nf=-75" "${outputloc}/aud/mic_${now}.wav" &
    echo $! > /tmp/audpid

    ffmpeg -f pulse -i default.monitor "${outputloc}/aud/desktop_${now}.wav" &
    echo $! > /tmp/deskaudpid

    echo "$now" > /tmp/recording_timestamp
    echo "$outputloc" > /tmp/recording_outputdir

    notify-send "ðŸŽ™ Recording started"
    restatus rt "$SIGNAL"
}

function end_record() {
    kill -15 "$(cat /tmp/recpid)" "$(cat /tmp/audpid)" "$(cat /tmp/deskaudpid)"
    wait

    now=$(cat /tmp/recording_timestamp)
    outputloc=$(cat /tmp/recording_outputdir)

    notify-send "Recording ended, merging files"
    ffmpeg \
        -i "${outputloc}/vid/video_${now}.mkv" \
        -i "${outputloc}/aud/mic_${now}.wav" \
        -i "${outputloc}/aud/desktop_${now}.wav" \
        -filter_complex "[1:a][2:a]amix=inputs=2:duration=shortest[aout]" \
        -map 0:v -metadata:s:v:0 title="Screen" \
        -map "[aout]" -metadata:s:a:0 title="Mixed Audio" -disposition:a:0 default \
        -map 1:a -metadata:s:a:1 title="Microphone" -disposition:a:1 0 \
        -map 2:a -metadata:s:a:2 title="System Audio" -disposition:a:2 0 \
        -c:v copy -c:a aac -shortest "${outputloc}/final.mkv"

    rm -fv /tmp/*pid /tmp/recording_timestamp /tmp/recording_outputdir
    notify-send "Recording merged"
    restatus rt "$SIGNAL"
}

function toggle_record() {
    if [[ -f /tmp/recpid ]]; then
        end_record
    else
        record
    fi
}

function start_stream() {
    ffmpeg -f x11grab -s "$RES" -r "$FPS_STREAM" -i :0.0 \
        -f alsa -i pulse -f alsa -i pulse \
        -filter_complex amix=inputs=2 -ac 2 -b:a 96k -ar 44100 \
        -vcodec libx264 -g 60 -keyint_min 30 -b:v 1500k -minrate 1500k -maxrate 1500k \
        -vf "scale=$screen_width:-1,format=yuv4"$SIGNAL"p" -preset ultrafast \
        -acodec libmp3lame -threads 3 -strict normal \
        -bufsize 1500k "rtmp://$SERVER.live-video.net/app/$STREAM_KEY" &
    echo $! > /tmp/streampid
    notify-send "ðŸ“¡ Twitch stream started"
    restatus rt "$SIGNAL"
}

function stop_stream() {
    kill -15 "$(cat /tmp/streampid)"
    wait
    rm -fv /tmp/streampid
    notify-send "Twitch stream stopped"
    restatus rt "$SIGNAL"
}

function toggle_stream() {
    if [[ -f /tmp/streampid ]]; then
        stop_stream
    else
        start_stream
    fi
}

# --- Main Menu ---
choice=$(printf "Record Toggle\nStream Toggle" | rofi -dmenu -p "Select action:")
case "$choice" in
    "Record Toggle") toggle_record ;;
    "Stream Toggle") toggle_stream ;;
    *) exit 1 ;;
esac

