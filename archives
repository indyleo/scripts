#!/usr/bin/env bash
# =====================================
# Archive Utility Script
# Supports: extract | archive
# =====================================

set -e

function usage() {
    cat <<'EOF'
Usage:
  archives extract <archive_file>
  archives archive <archive_name> <file1> [file2 ... fileN]

Description:
  A simple archive utility to extract or create common archive formats.

Supported extraction formats:
  .tar.bz2, .tar.gz, .bz2, .rar, .gz, .tar, .tbz2, .tgz, .zip, .Z, .7z, .deb, .tar.xz, .tar.zst

Supported archive formats:
  .tar.gz, .zip, .rar

Examples:
  archives extract data.tar.gz
  archives archive backup.zip file1.txt file2.txt
EOF
    exit 1
}

# --- Extraction function ---
function extract() {
    local file="$1"
    if [[ -z "$file" ]]; then
        echo "Error: No file specified for extraction."
        usage
    fi

    if [[ ! -f "$file" ]]; then
        echo "Error: '$file' is not a valid file."
        exit 1
    fi

    # Determine a target directory
    local base_name
    base_name=$(basename "$file")
    local dir_name="${base_name%.*}"  # remove extension, may need tweak for double extensions

    # Handle double extensions like .tar.gz, .tar.bz2, .tar.xz, .tar.zst
    if [[ "$file" =~ \.tar\.gz$ || "$file" =~ \.tar\.bz2$ || "$file" =~ \.tar\.xz$ || "$file" =~ \.tar\.zst$ ]]; then
        dir_name="${base_name%.*.*}"
    elif [[ "$file" =~ \.tbz2$ || "$file" =~ \.tgz$ ]]; then
        dir_name="${base_name%.*.*}"
    fi

    # Check if archive contents already have a top-level directory
    local temp_dir
    temp_dir=$(mktemp -d)
    case "$file" in
        *.tar.bz2|*.tar.gz|*.tar|*.tbz2|*.tgz|*.tar.xz|*.tar.zst)
            tar -tf "$file" | head -1 > "$temp_dir/first_entry.txt"
            ;;
        *.zip)
            unzip -l "$file" | awk 'NR>3 {print $4}' | head -1 > "$temp_dir/first_entry.txt"
            ;;
        *.7z)
            7z l "$file" | awk '/^----/{flag=1;next} /^----/{flag=0} flag {print $6}' | head -1 > "$temp_dir/first_entry.txt"
            ;;
        *.rar)
            unrar lb "$file" | head -1 > "$temp_dir/first_entry.txt"
            ;;
        *)
            echo "Warning: Cannot determine archive structure for '$file'"
            ;;
    esac

    local first_entry
    first_entry=$(cat "$temp_dir/first_entry.txt" | cut -d/ -f1)

    rm -rf "$temp_dir"

    # If the first entry is not a directory, create one
    if [[ ! -d "$first_entry" ]]; then
        mkdir -p "$dir_name"
        case "$file" in
            *.tar.bz2) tar xjf "$file" -C "$dir_name" ;;
            *.tar.gz)  tar xzf "$file" -C "$dir_name" ;;
            *.bz2)     bunzip2 -c "$file" > "$dir_name/$dir_name" ;;
            *.rar)     unrar x "$file" "$dir_name/" ;;
            *.gz)      gunzip -c "$file" > "$dir_name/$dir_name" ;;
            *.tar)     tar xf "$file" -C "$dir_name" ;;
            *.tbz2)    tar xjf "$file" -C "$dir_name" ;;
            *.tgz)     tar xzf "$file" -C "$dir_name" ;;
            *.zip)     unzip "$file" -d "$dir_name" ;;
            *.Z)       uncompress -c "$file" > "$dir_name/$dir_name" ;;
            *.7z)      7z x "$file" -o"$dir_name" ;;
            *.deb)     ar x "$file" -C "$dir_name" ;;
            *.tar.xz)  tar xf "$file" -C "$dir_name" ;;
            *.tar.zst) unzstd -c "$file" | tar xf - -C "$dir_name" ;;
            *)         echo "Error: '$file' cannot be extracted via this script." ;;
        esac
        echo "✅ Extracted to directory: $dir_name"
    else
        # Archive already has a top-level directory
        case "$file" in
            *.tar.bz2) tar xjf "$file" ;;
            *.tar.gz)  tar xzf "$file" ;;
            *.bz2)     bunzip2 "$file" ;;
            *.rar)     unrar x "$file" ;;
            *.gz)      gunzip "$file" ;;
            *.tar)     tar xf "$file" ;;
            *.tbz2)    tar xjf "$file" ;;
            *.tgz)     tar xzf "$file" ;;
            *.zip)     unzip "$file" ;;
            *.Z)       uncompress "$file" ;;
            *.7z)      7z x "$file" ;;
            *.deb)     ar x "$file" ;;
            *.tar.xz)  tar xf "$file" ;;
            *.tar.zst) unzstd "$file" ;;
        esac
        echo "✅ Extracted archive contents (already in top-level directory)"
    fi
}

# --- Archiving function ---
function archive() {
    local archive_name="$1"
    shift
    local files=("$@")

    if [[ -z "$archive_name" || "${#files[@]}" -lt 1 ]]; then
        echo "Error: Missing archive name or files."
        usage
    fi

    if [[ -e "$archive_name" ]]; then
        echo "Error: Archive '$archive_name' already exists."
        exit 1
    fi

    case "$archive_name" in
        *.tar.gz)
            tar -czf "$archive_name" "${files[@]}"
            ;;
        *.zip)
            zip -r "$archive_name" "${files[@]}"
            ;;
        *.rar)
            if command -v rar > /dev/null; then
                rar a "$archive_name" "${files[@]}"
            else
                echo "Error: 'rar' command not found. Please install RAR to create .rar archives."
                exit 1
            fi
            ;;
        *)
            echo "Error: Unsupported archive format."
            echo "Supported: .tar.gz, .zip, .rar"
            exit 1
            ;;
    esac

    echo "✅ Archive created: $archive_name"
}

# --- Main dispatcher ---
if [[ $# -lt 1 ]]; then
    usage
fi

command="$1"
shift

case "$command" in
    extract) extract "$@" ;;
    archive) archive "$@" ;;
    help|--help|-h) usage ;;
    *)
        echo "Error: Unknown command '$command'"
        usage
        ;;
esac

