#!/usr/bin/env bash

# Strict mode: Exit on error, unset vars, and pipe failures
set -euo pipefail

opt="${1:-}"

function ttime() {
    date +"󰥔  %I:%M %p"
}

function ddate() {
    date +"   %A %B %d %Y"
}

function date_time() {
    date +"󰥔  %I:%M %p |   %A %B %d %Y"
}

function cpu_load() {
    local usage temp
    local cpu1 cpu2 idle1 idle2 total1 total2

    read -r cpu1 <<< "$(grep '^cpu ' /proc/stat)"
    sleep 0.1
    read -r cpu2 <<< "$(grep '^cpu ' /proc/stat)"

    local -a vals1=($cpu1)
    local -a vals2=($cpu2)

    idle1="${vals1[4]}"
    idle2="${vals2[4]}"

    total1=0
    total2=0
    for ((i=1; i<=7; i++)); do
        total1=$((total1 + ${vals1[$i]:-0}))
        total2=$((total2 + ${vals2[$i]:-0}))
    done

    local total_diff=$((total2 - total1))
    local idle_diff=$((idle2 - idle1))

    if [[ $total_diff -gt 0 ]]; then
        usage=$(awk -v total="$total_diff" -v idle="$idle_diff" 'BEGIN {printf "%.0f", ((total - idle) / total) * 100}')
    else
        usage=0
    fi

    if [[ -d /sys/class/hwmon ]]; then
        for hwmon in /sys/class/hwmon/hwmon*/name; do
            if [[ -f "$hwmon" ]] && grep -q "coretemp\|k10temp\|zenpower" "$hwmon" 2>/dev/null; then
                local hwmon_dir=$(dirname "$hwmon")
                if [[ -f "$hwmon_dir/temp1_input" ]]; then
                    temp=$(cat "$hwmon_dir"/temp1_input 2>/dev/null | awk '{print int($1/1000)}' || echo "")
                    break
                fi
            fi
        done
    fi

    if [[ -n "$temp" ]]; then
        echo "  ${usage}% (${temp}°C)"
    else
        echo "  ${usage}%"
    fi
}

function disk_usage() {
    local mount used_human total_human percent used_gb total_gb
    mount="/"
    read -r used_human total_human percent <<< "$(df -h / | awk 'NR==2 {print $3, $2, $5}')"
    percent="${percent%\%}"

    used_gb=$(echo "$used_human" | awk '{
        val = $1; sub(/[KMGT]/, "", val);
        if ($1 ~ /K/) print val/1024/1024;
        else if ($1 ~ /M/) print val/1024;
        else if ($1 ~ /G/) print val;
        else if ($1 ~ /T/) print val*1024;
        else print val/1024/1024/1024;
    }' | awk '{printf "%.1f", $1}')

    total_gb=$(echo "$total_human" | awk '{
        val = $1; sub(/[KMGT]/, "", val);
        if ($1 ~ /K/) print val/1024/1024;
        else if ($1 ~ /M/) print val/1024;
        else if ($1 ~ /G/) print val;
        else if ($1 ~ /T/) print val*1024;
        else print val/1024/1024/1024;
    }' | awk '{printf "%.1f", $1}')

    echo "󰋊 ${mount}: ${percent}% (${used_gb}G/${total_gb}G)"
}

function memory_usage() {
    local used_kb total_kb used_gb total_gb percent
    read -r total_kb used_kb <<< "$(free | awk 'NR==2 {print $2, $3}')"
    used_gb=$(awk -v used="$used_kb" 'BEGIN {printf "%.1f", used/1024/1024}')
    total_gb=$(awk -v total="$total_kb" 'BEGIN {printf "%.1f", total/1024/1024}')
    percent=$(awk -v used="$used_kb" -v total="$total_kb" 'BEGIN {printf "%.0f", (used/total)*100}')
    echo "  ${percent}% (${used_gb}G/${total_gb}G)"
}

function eethernet() {
    local interface found=0

    # Iterate through all network interfaces
    for dev in /sys/class/net/*; do
        interface=$(basename "$dev")

        # Filter: Skip loopback, wireless, and virtual interfaces (docker, br, veth, etc.)
        # Physical interfaces usually have a 'device' symlink in sysfs
        if [[ "$interface" != "lo" && ! -d "$dev/wireless" && -d "$dev/device" ]]; then
            # Check the carrier file: 1 means cable is detected and link is up
            if [[ -f "$dev/carrier" ]] && [[ "$(cat "$dev/carrier" 2>/dev/null)" == "1" ]]; then
                echo "󰈀 Connected"
                return
            fi
            found=1
        fi
    done

    # If we found physical ports but none had a carrier
    if [[ $found -eq 1 ]]; then
        echo "󰲜 Disconnected"
    else
        echo "󰲜 No Ethernet"
    fi
}


function wifi_status() {
    local current icon msg quality
    if command -v nmcli &> /dev/null; then
        local nmcli_output active_line
        nmcli_output=$(nmcli -t -f active,ssid,signal dev wifi 2>/dev/null || echo "")
        if [[ -n "$nmcli_output" ]]; then
            active_line=$(echo "$nmcli_output" | grep "^yes:" | head -n 1)
            if [[ -n "$active_line" ]]; then
                current=$(echo "$active_line" | cut -d':' -f2)
                quality=$(echo "$active_line" | cut -d':' -f3)
                if   [[ $quality -ge 75 ]]; then icon="󰤨"
                elif [[ $quality -ge 50 ]]; then icon="󰤥"
                elif [[ $quality -ge 25 ]]; then icon="󰤢"
                else                           icon="󰤟"
                fi
                echo "${icon} ${current} (${quality}%)"
                return
            fi
        fi
        echo "󰤮 Offline"
        return
    fi
    echo "󰤮 No tool"
}

function tail_status() {
    local icon msg status_out
    if ! command -v tailscale &> /dev/null; then
        echo "󰈂 No tool"
        return
    fi
    if status_out=$(tailscale status 2>&1); then
        if echo "$status_out" | grep -q "Logged out"; then
            icon="󰈂"; msg="Not connected"
        else
            icon="󰈁"; msg="Connected"
        fi
    else
        icon="󰈂"; msg="Not connected"
    fi
    echo "${icon} ${msg}"
}

function is_media() {
    local rec=0 stream=0 icon msg
    [[ -f "/tmp/recpid" ]] && rec=1
    [[ -f "/tmp/streampid" ]] && stream=1
    if [[ $rec -eq 1 && $stream -eq 1 ]]; then
        icon=" 󰑊"; msg="Recording & Streaming"
    elif [[ $rec -eq 1 ]]; then
        icon=" 󰑊"; msg="Recording"
    elif [[ $stream -eq 1 ]]; then
        icon=" 󰑊"; msg="Streaming"
    else
        icon=" "; msg="Idle"
    fi
    echo "${icon} ${msg}"
}

function bbattery() {
    local battery_info valid_batteries active_battery_line percent status icon time_left
    if ! command -v acpi &> /dev/null; then
        echo "󰂑 No acpi"; return
    fi
    battery_info=$(acpi -b 2>/dev/null || echo "")
    [[ -z "$battery_info" ]] && return
    valid_batteries=$(echo "$battery_info" | grep -v "Unknown" | grep -v "rate information unavailable" || true)
    active_battery_line=$([[ -n "$valid_batteries" ]] && echo "$valid_batteries" | head -n 1 || echo "$battery_info" | head -n 1)
    percent=$(echo "$active_battery_line" | grep -o '[0-9]\+%' | tr -d '%' | head -n 1 || echo "0")
    status=$(echo "$active_battery_line" | awk -F', ' '{print $1}' | awk -F': ' '{print $2}' || echo "Unknown")
    time_left=$(echo "$active_battery_line" | grep -oP '\d+:\d+:\d+' | head -n 1 || echo "")
    [[ -n "$time_left" ]] && time_left=$(echo "$time_left" | awk -F: '{printf "%d:%02d", $1, $2}')

    case "$status" in
        Charging|Not\ charging)
            if [[ $percent -ge 100 ]]; then icon="󰂅"
            elif [[ $percent -ge 90 ]]; then icon="󰂋"
            elif [[ $percent -ge 80 ]]; then icon="󰂊"
            elif [[ $percent -ge 70 ]]; then icon="󰢞"
            elif [[ $percent -ge 60 ]]; then icon="󰂉"
            elif [[ $percent -ge 50 ]]; then icon="󰢝"
            elif [[ $percent -ge 40 ]]; then icon="󰂈"
            elif [[ $percent -ge 30 ]]; then icon="󰂇"
            elif [[ $percent -ge 20 ]]; then icon="󰂆"
            elif [[ $percent -ge 10 ]]; then icon="󰢜"
            else icon="󰢟"; fi ;;
        Discharging)
            if [[ $percent -ge 100 ]]; then icon="󰁹"
            elif [[ $percent -ge 90 ]]; then icon="󰂂"
            elif [[ $percent -ge 80 ]]; then icon="󰂁"
            elif [[ $percent -ge 70 ]]; then icon="󰂀"
            elif [[ $percent -ge 60 ]]; then icon="󰁿"
            elif [[ $percent -ge 50 ]]; then icon="󰁾"
            elif [[ $percent -ge 40 ]]; then icon="󰁽"
            elif [[ $percent -ge 30 ]]; then icon="󰁼"
            elif [[ $percent -ge 20 ]]; then icon="󰁻"
            elif [[ $percent -ge 10 ]]; then icon="󰁺"
            else icon="󰂎"; fi ;;
        Full) icon="󰂄" ;;
        *) icon="󰂑" ;;
    esac
    [[ -n "$time_left" ]] && echo "${icon} ${percent}% (${time_left})" || echo "${icon} ${percent}%"
}

function vvolume() {
    local vol muted icon msg
    if ! command -v pamixer &> /dev/null; then
        echo "󰝟 No tool"; return
    fi
    vol="$(pamixer --get-volume 2>/dev/null || echo "0")"
    muted=$(pamixer --get-mute 2>/dev/null || echo "false")
    if [[ "$muted" == "true" || "$vol" -eq 0 ]]; then
        icon="󰝟"; msg="Muted"
    elif [[ "$vol" -eq 100 ]]; then icon="󰶬"; msg="${vol}%"
    elif [[ "$vol" -ge 75 ]]; then icon="󰕾"; msg="${vol}%"
    elif [[ "$vol" -ge 25 ]]; then icon="󰖀"; msg="${vol}%"
    else icon="󰕿"; msg="${vol}%"; fi
    echo "${icon} ${msg}"
}

function mmicrophone() {
    local vol muted icon msg
    if ! command -v pamixer &> /dev/null; then
        echo " No tool"; return
    fi
    vol="$(pamixer --default-source --get-volume 2>/dev/null || echo 0)"
    muted="$(pamixer --default-source --get-mute 2>/dev/null || echo false)"
    if [[ "$muted" == "false" && "$vol" -gt 0 ]]; then
        icon=""; msg="${vol}%"
    else
        icon=""; msg="Muted"
    fi
    echo "${icon} ${msg}"
}

function bbrightness() {
    local brightness_raw max_brightness brightness icon backlight_dir
    backlight_dir=$(find /sys/class/backlight/ -mindepth 1 -maxdepth 1 -print -quit 2>/dev/null)
    if [[ -z "$backlight_dir" ]]; then
        echo "󰛨 N/A"; return
    fi
    brightness_raw=$(cat "$backlight_dir/brightness" 2>/dev/null || echo "0")
    max_brightness=$(cat "$backlight_dir/max_brightness" 2>/dev/null || echo "100")
    brightness=$(( (brightness_raw * 100 + max_brightness / 2) / max_brightness ))
    if   [[ "$brightness" -ge 100 ]]; then icon="󰛨"
    elif [[ "$brightness" -ge 50 ]];  then icon="󱩓"
    else                                icon="󱩎"; fi
    echo "${icon} ${brightness}%"
}

function ggpu() {
    local usage="" temp="" gpu_type=""

    # 1. Try NVIDIA first
    if command -v nvidia-smi &> /dev/null; then
        local dgpu_info
        dgpu_info=$(nvidia-smi --query-gpu=utilization.gpu,temperature.gpu --format=csv,noheader,nounits 2>/dev/null | head -n 1)
        if [[ -n "$dgpu_info" && "$dgpu_info" != *"failed"* ]]; then
            usage=$(echo "$dgpu_info" | awk -F', ' '{print $1}')
            temp=$(echo "$dgpu_info" | awk -F', ' '{print $2}')
            echo "󰢮 ${usage}% (${temp}°C)"
            return
        fi
    fi

    # 2. Try AMD iGPU/dGPU via sysfs
    # Check for the standard 'gpu_busy_percent' file
    if [[ -f /sys/class/drm/card0/device/gpu_busy_percent ]]; then
        usage=$(cat /sys/class/drm/card0/device/gpu_busy_percent 2>/dev/null)
        # AMD temperature is often in hwmon
        for hwmon in /sys/class/drm/card0/device/hwmon/hwmon*/temp1_input; do
            if [[ -f "$hwmon" ]]; then
                temp=$(awk '{print int($1/1000)}' "$hwmon")
                break
            fi
        done
        [[ -n "$usage" ]] && { echo "󰢮 ${usage}% (${temp:-?}°C)"; return; }
    fi

    # 3. Try Intel iGPU via Frequency (Proxy for Load)
    # Intel doesn't have a 'busy_percent' file without debugfs (root)
    # So we calculate the ratio of current frequency vs max frequency
    if [[ -f /sys/class/drm/card0/gt_cur_freq_mhz ]]; then
        local cur max
        cur=$(cat /sys/class/drm/card0/gt_cur_freq_mhz 2>/dev/null)
        max=$(cat /sys/class/drm/card0/gt_max_freq_mhz 2>/dev/null)
        if [[ -n "$cur" && -n "$max" && "$max" -gt 0 ]]; then
            usage=$(( cur * 100 / max ))
            echo "󰢮 ${usage}% (${cur}MHz)"
            return
        fi
    fi

    # 4. Final Fallback: Just detect the brand if stats fail
    if lspci 2>/dev/null | grep -iq 'vga.*intel'; then
        gpu_type="Intel"
    elif lspci 2>/dev/null | grep -iq 'vga.*amd'; then
        gpu_type="AMD"
    fi

    if [[ -n "$gpu_type" ]]; then
        echo "󰢮 ${gpu_type}"
    else
        echo "󰢮 N/A"
    fi
}

function kkernel() {
    echo "󰌽 $(uname -r 2>/dev/null || echo "Unknown")"
}

function all_stats() {
    echo "$(is_media) | $(disk_usage) | $(memory_usage) | $(cpu_load) | $(bbrightness) | $(mmicrophone) | $(vvolume) | $(bbattery) | $(ggpu) | $(kkernel) | $(eethernet) | $(wifi_status) | $(tail_status) | $(date_time)"
}

function help_menu() {
    cat <<EOF
    Usage: $(basename "$0") [OPTION]

    Display system statistics for bars.

    Options:
    -h, --help      Show this help message
    cpu             Display CPU load
    mem             Display memory usage
    disk            Display disk usage
    ethernet        Display Ethernet status
    wifi            Display WiFi status
    tail            Display Tailscale status
    date            Display date
    time            Display time
    date_time       Display date and time
    ismedia         Display recording/streaming status
    battery         Display battery status
    volume          Display volume
    microphone      Display microphone status
    brightness      Display brightness
    gpu             Display GPU info
    kernel          Display kernel version
    all             Display all stats
EOF
}

case "$opt" in
    cpu)        cpu_load ;;
    mem)        memory_usage ;;
    disk)       disk_usage ;;
    ethernet)   eethernet ;;
    wifi)       wifi_status ;;
    tail)       tail_status ;;
    date)       ddate ;;
    time)       ttime ;;
    date_time)  date_time ;;
    ismedia)    is_media ;;
    battery)    bbattery ;;
    volume)     vvolume ;;
    microphone) mmicrophone ;;
    brightness) bbrightness ;;
    gpu)        ggpu ;;
    kernel)     kkernel ;;
    all)        all_stats ;;
    --help|-h|"") help_menu ;;
    *)
        echo "Error: Unknown argument '${opt}'." >&2
        exit 1
        ;;
esac
