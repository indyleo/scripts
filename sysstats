#!/usr/bin/env bash

# Strict mode: Exit on error, unset vars, and pipe failures
set -euo pipefail

opt="${1:-}"

function ttime() {
    date +"󰥔  %I:%M %p"
}

function ddate() {
    date +"   %A %B %d %Y"
}

function date_time() {
    date +"󰥔  %I:%M %p |   %A %B %d %Y"
}

function cpu_load() {
    local usage temp

    # Get CPU usage from /proc/stat
    # Read CPU line twice with a small delay to calculate usage
    local cpu1 cpu2 idle1 idle2 total1 total2

    read -r cpu1 <<< "$(grep '^cpu ' /proc/stat)"
    sleep 0.1
    read -r cpu2 <<< "$(grep '^cpu ' /proc/stat)"

    # Parse the values (user, nice, system, idle, iowait, irq, softirq, steal)
    local -a vals1=($cpu1)
    local -a vals2=($cpu2)

    idle1="${vals1[4]}"
    idle2="${vals2[4]}"

    # Calculate total CPU time
    total1=0
    total2=0
    for ((i=1; i<=7; i++)); do
        total1=$((total1 + ${vals1[$i]:-0}))
        total2=$((total2 + ${vals2[$i]:-0}))
    done

    # Calculate usage percentage
    local total_diff=$((total2 - total1))
    local idle_diff=$((idle2 - idle1))

    if [[ $total_diff -gt 0 ]]; then
        usage=$(awk -v total="$total_diff" -v idle="$idle_diff" 'BEGIN {printf "%.0f", ((total - idle) / total) * 100}')
    else
        usage=0
    fi

    # Get CPU temperature from hwmon
    if [[ -d /sys/class/hwmon ]]; then
        for hwmon in /sys/class/hwmon/hwmon*/name; do
            if [[ -f "$hwmon" ]] && grep -q "coretemp\|k10temp\|zenpower" "$hwmon" 2>/dev/null; then
                local hwmon_dir=$(dirname "$hwmon")
                # Try to find Package temp first, otherwise use first temp sensor
                if [[ -f "$hwmon_dir/temp1_input" ]]; then
                    temp=$(cat "$hwmon_dir"/temp1_input 2>/dev/null | awk '{print int($1/1000)}' || echo "")
                    break
                fi
            fi
        done
    fi

    if [[ -n "$temp" ]]; then
        echo "  ${usage}% (${temp}°C)"
    else
        echo "  ${usage}%"
    fi
}

function disk_usage() {
    local mount used_human total_human percent used_gb total_gb

    # Get root filesystem info
    mount="/"
    read -r used_human total_human percent <<< "$(df -h / | awk 'NR==2 {print $3, $2, $5}')"

    # Remove % sign from percent
    percent="${percent%\%}"

    # Convert to GB (handle K, M, G, T suffixes)
    used_gb=$(echo "$used_human" | awk '{
        val = $1; sub(/[KMGT]/, "", val);
        if ($1 ~ /K/) print val/1024/1024;
        else if ($1 ~ /M/) print val/1024;
        else if ($1 ~ /G/) print val;
        else if ($1 ~ /T/) print val*1024;
        else print val/1024/1024/1024;
    }' | awk '{printf "%.1f", $1}')

    total_gb=$(echo "$total_human" | awk '{
        val = $1; sub(/[KMGT]/, "", val);
        if ($1 ~ /K/) print val/1024/1024;
        else if ($1 ~ /M/) print val/1024;
        else if ($1 ~ /G/) print val;
        else if ($1 ~ /T/) print val*1024;
        else print val/1024/1024/1024;
    }' | awk '{printf "%.1f", $1}')

    echo "󰋊 ${mount}: ${percent}% (${used_gb}G/${total_gb}G)"
}

function memory_usage() {
    local used_kb total_kb used_gb total_gb percent

    # Get memory info in KB
    read -r total_kb used_kb <<< "$(free | awk 'NR==2 {print $2, $3}')"

    # Convert to GB with 1 decimal place
    used_gb=$(awk -v used="$used_kb" 'BEGIN {printf "%.1f", used/1024/1024}')
    total_gb=$(awk -v total="$total_kb" 'BEGIN {printf "%.1f", total/1024/1024}')

    # Calculate percentage
    percent=$(awk -v used="$used_kb" -v total="$total_kb" 'BEGIN {printf "%.0f", (used/total)*100}')

    echo "  ${percent}% (${used_gb}G/${total_gb}G)"
}

function wifi_status() {
    local current icon msg quality

    # Try nmcli first (NetworkManager)
    if command -v nmcli &> /dev/null; then
        local nmcli_output active_line
        nmcli_output=$(nmcli -t -f active,ssid,signal dev wifi 2>/dev/null || echo "")

        if [[ -n "$nmcli_output" ]]; then
            # Find the line starting with "yes" (active connection)
            active_line=$(echo "$nmcli_output" | grep "^yes:" | head -n 1)

            if [[ -n "$active_line" ]]; then
                # Parse: yes:SSID:SIGNAL
                current=$(echo "$active_line" | cut -d':' -f2)
                quality=$(echo "$active_line" | cut -d':' -f3)

                # Set icon based on signal strength
                if   [[ $quality -ge 75 ]]; then icon="󰖩"
                elif [[ $quality -ge 50 ]]; then icon="󰖨"
                elif [[ $quality -ge 25 ]]; then icon="󰖥"
                else                             icon="󰖡"
                fi

                msg="$current ${quality}%"
                echo "${icon} ${msg}"
                return
            fi
        fi

        # If we get here, no active connection via nmcli
        echo "󰖪 Offline"
        return
    fi

    # Fallback to iwgetid if nmcli not available
    if ! command -v iwgetid &> /dev/null; then
        echo "󰖪 No tool"
        return
    fi

    current=$(iwgetid -r 2>/dev/null || true)

    if [[ -z "$current" ]]; then
        icon="󰖪"
        msg="Disconnected"
    else
        # Get signal strength using iwconfig or iw
        if command -v iwconfig &> /dev/null; then
            # Try iwconfig first (reports in dBm or quality)
            signal_strength=$(iwconfig 2>/dev/null | grep -i 'link quality' | awk '{print $2}' | cut -d'=' -f2 || echo "")

            # If we got a fraction like "70/100", convert to percentage
            if [[ "$signal_strength" =~ ^[0-9]+/[0-9]+$ ]]; then
                local numerator denominator
                numerator=$(echo "$signal_strength" | cut -d'/' -f1)
                denominator=$(echo "$signal_strength" | cut -d'/' -f2)
                quality=$(( (numerator * 100) / denominator ))
            else
                signal_strength=""
            fi
        fi

        # If iwconfig didn't work, try iw
        if [[ -z "$signal_strength" ]] && command -v iw &> /dev/null; then
            local interface dbm
            interface=$(iwgetid | cut -d' ' -f1 2>/dev/null || echo "")
            if [[ -n "$interface" ]]; then
                dbm=$(iw dev "$interface" link 2>/dev/null | grep 'signal:' | awk '{print $2}' || echo "")

                # Convert dBm to percentage (rough approximation)
                # -30 dBm = 100%, -90 dBm = 0%
                if [[ -n "$dbm" && "$dbm" =~ ^-?[0-9]+$ ]]; then
                    if [[ $dbm -ge -30 ]]; then
                        quality=100
                    elif [[ $dbm -le -90 ]]; then
                        quality=0
                    else
                        quality=$(( 100 - ((dbm + 30) * 100 / -60) ))
                        quality=$(( quality < 0 ? 0 : quality ))
                        quality=$(( quality > 100 ? 100 : quality ))
                    fi
                fi
            fi
        fi

        # Set icon based on signal strength
        if [[ -n "$quality" ]]; then
            if   [[ $quality -ge 75 ]]; then icon="󰖩"
            elif [[ $quality -ge 50 ]]; then icon="󰖨"
            elif [[ $quality -ge 25 ]]; then icon="󰖥"
            else                             icon="󰖡"
            fi
            msg="$current ${quality}%"
        else
            icon="󰖩"
            msg="$current"
        fi
    fi
    echo "${icon} ${msg}"
}

function tail_status() {
    local icon msg status_out

    # check if tailscale exists
    if ! command -v tailscale &> /dev/null; then
        echo "󰈂 No tool"
        return
    fi

    # Capture output once to prevent lag
    if status_out=$(tailscale status 2>&1); then
        if echo "$status_out" | grep -q "Logged out"; then
            icon="󰈂"
            msg="Not connected"
        else
            icon="󰈁"
            msg="Connected"
        fi
    else
        icon="󰈂"
        msg="Not connected"
    fi
    echo "${icon} ${msg}"
}

function is_media() {
    local rec=0 stream=0 icon msg

    [[ -f "/tmp/recpid" ]] && rec=1
    [[ -f "/tmp/streampid" ]] && stream=1

    if [[ $rec -eq 1 && $stream -eq 1 ]]; then
        icon=" 󰑊"
        msg="Recording & Streaming"
    elif [[ $rec -eq 1 ]]; then
        icon=" 󰑊"
        msg="Recording"
    elif [[ $stream -eq 1 ]]; then
        icon=" 󰑊"
        msg="Streaming"
    else
        icon=" "
        msg="Idle"
    fi

    echo "${icon} ${msg}"
}

function bbattery() {
    local battery_info valid_batteries active_battery_line percent status icon time_left

    if ! command -v acpi &> /dev/null; then
        echo "󰂑 No acpi"
        return
    fi

    battery_info=$(acpi -b 2>/dev/null || echo "")
    [[ -z "$battery_info" ]] && return

    # Filter out unknowns, grab the first valid line
    valid_batteries=$(echo "$battery_info" | grep -v "Unknown" | grep -v "rate information unavailable" || true)

    if [[ -n "$valid_batteries" ]]; then
        active_battery_line=$(echo "$valid_batteries" | head -n 1)
    else
        active_battery_line=$(echo "$battery_info" | head -n 1)
    fi

    # Extract percentage safely
    percent=$(echo "$active_battery_line" | grep -o '[0-9]\+%' | tr -d '%' | head -n 1 || echo "0")

    # Extract status safely
    status=$(echo "$active_battery_line" | awk -F', ' '{print $1}' | awk -F': ' '{print $2}' || echo "Unknown")

    # Extract time remaining (format: HH:MM:SS or until charged)
    time_left=$(echo "$active_battery_line" | grep -oP '\d+:\d+:\d+' | head -n 1 || echo "")
    if [[ -n "$time_left" ]]; then
        # Convert HH:MM:SS to HH:MM
        time_left=$(echo "$time_left" | awk -F: '{printf "%d:%02d", $1, $2}')
    fi

    case "$status" in
        Charging|Not\ charging)
            if    [[ $percent -ge 100 ]]; then icon="󰂅"
            elif [[ $percent -ge 90 ]];  then icon="󰂋"
            elif [[ $percent -ge 80 ]];  then icon="󰂊"
            elif [[ $percent -ge 70 ]];  then icon="󰢞"
            elif [[ $percent -ge 60 ]];  then icon="󰂉"
            elif [[ $percent -ge 50 ]];  then icon="󰢝"
            elif [[ $percent -ge 40 ]];  then icon="󰂈"
            elif [[ $percent -ge 30 ]];  then icon="󰂇"
            elif [[ $percent -ge 20 ]];  then icon="󰂆"
            elif [[ $percent -ge 10 ]];  then icon="󰢜"
            else                          icon="󰢟"
            fi
            ;;
        Discharging)
            if    [[ $percent -ge 100 ]]; then icon="󰁹"
            elif [[ $percent -ge 90 ]];  then icon="󰂂"
            elif [[ $percent -ge 80 ]];  then icon="󰂁"
            elif [[ $percent -ge 70 ]];  then icon="󰂀"
            elif [[ $percent -ge 60 ]];  then icon="󰁿"
            elif [[ $percent -ge 50 ]];  then icon="󰁾"
            elif [[ $percent -ge 40 ]];  then icon="󰁽"
            elif [[ $percent -ge 30 ]];  then icon="󰁼"
            elif [[ $percent -ge 20 ]];  then icon="󰁻"
            elif [[ $percent -ge 10 ]];  then icon="󰁺"
            else                          icon="󰂎"
            fi
            ;;
        Full)
            icon="󰂄"
            ;;
        *)
            icon="󰂑"
            ;;
    esac

    if [[ -n "$time_left" ]]; then
        echo "${icon} ${percent}% (${time_left})"
    else
        echo "${icon} ${percent}%"
    fi
}

function vvolume() {
    local vol muted icon msg

    if ! command -v pamixer &> /dev/null; then
        echo "󰝟 No tool"
        return
    fi

    vol="$(pamixer --get-volume 2>/dev/null || echo "0")"
    muted=$(pamixer --get-mute 2>/dev/null || echo "false")

    if [[ "$muted" == "true" || "$vol" -eq 0 ]]; then
        icon="󰝟"
        msg="Muted"
    elif [[ "$vol" -eq 100 ]]; then
        icon="󰶬"
        msg="${vol}%"
    elif [[ "$vol" -ge 75 ]]; then
        icon="󰕾"
        msg="${vol}%"
    elif [[ "$vol" -ge 50 ]]; then
        icon="󰕾"
        msg="${vol}%"
    elif [[ "$vol" -ge 25 ]]; then
        icon="󰖀"
        msg="${vol}%"
    else
        icon="󰕿"
        msg="${vol}%"
    fi

    echo "${icon} ${msg}"
}

function mmicrophone() {
    local vol muted icon msg

    if ! command -v pamixer &> /dev/null; then
        echo " No tool"
        return
    fi

    vol="$(pamixer --default-source --get-volume 2>/dev/null || echo 0)"
    muted="$(pamixer --default-source --get-mute 2>/dev/null || echo false)"

    if [[ "$muted" == "false" && "$vol" -gt 0 ]]; then
        icon=""
        msg="${vol}%"
    else
        icon=""
        msg="Muted"
    fi

    echo "${icon} ${msg}"
}

function bbrightness() {
    local brightness_raw max_brightness brightness icon backlight_dir

    # Fix: Handle multiple backlight controllers by picking the first one found
    backlight_dir=$(find /sys/class/backlight/ -mindepth 1 -maxdepth 1 -print -quit 2>/dev/null)

    if [[ -z "$backlight_dir" ]]; then
        echo "󰛨 N/A"
        return
    fi

    brightness_raw=$(cat "$backlight_dir/brightness" 2>/dev/null || echo "0")
    max_brightness=$(cat "$backlight_dir/max_brightness" 2>/dev/null || echo "100")

    [[ -z "$brightness_raw" || -z "$max_brightness" || "$max_brightness" -eq 0 ]] && brightness=0 || \
        brightness=$(( (brightness_raw * 100 + max_brightness / 2) / max_brightness ))

    if   [[ "$brightness" -ge 100 ]]; then icon="󰛨"
    elif [[ "$brightness" -ge 90 ]];  then icon="󱩖"
    elif [[ "$brightness" -ge 80 ]];  then icon="󱩖"
    elif [[ "$brightness" -ge 70 ]];  then icon="󱩕"
    elif [[ "$brightness" -ge 60 ]];  then icon="󱩔"
    elif [[ "$brightness" -ge 50 ]];  then icon="󱩓"
    elif [[ "$brightness" -ge 40 ]];  then icon="󱩒"
    elif [[ "$brightness" -ge 30 ]];  then icon="󱩑"
    elif [[ "$brightness" -ge 20 ]];  then icon="󱩐"
    elif [[ "$brightness" -ge 10 ]];  then icon="󱩏"
    else                                icon="󱩎"
    fi

    echo "${icon} ${brightness}%"
}

function ggpu() {
    local dgpu_info usage="" temp="" gpu_type=""

    # Try to detect discrete GPU (NVIDIA, AMD)
    if command -v nvidia-smi &> /dev/null; then
        # NVIDIA GPU detected - check if it's actually working
        dgpu_info=$(nvidia-smi --query-gpu=utilization.gpu,temperature.gpu --format=csv,noheader,nounits 2>/dev/null | head -n 1 || echo "")
        # If nvidia-smi failed or returned error message, clear it
        if [[ "$dgpu_info" == *"failed"* ]] || [[ "$dgpu_info" == *"NVIDIA-SMI"* ]] || [[ -z "$dgpu_info" ]]; then
            dgpu_info=""
        else
            usage=$(echo "$dgpu_info" | awk -F', ' '{print $1}' | tr -d ' ')
            temp=$(echo "$dgpu_info" | awk -F', ' '{print $2}' | tr -d ' ')
            gpu_type="dGPU"
        fi
    fi

    # Try AMD discrete GPU if NVIDIA didn't work
    if [[ -z "$dgpu_info" ]] && command -v radeontop &> /dev/null; then
        # radeontop can get AMD stats but requires special handling
        # For now, just detect if AMD GPU exists
        if lspci 2>/dev/null | grep -iq 'vga.*amd\|vga.*radeon\|3d.*amd'; then
            gpu_type="dGPU"
        fi
    fi

    # Fallback to integrated GPU if no discrete GPU was found
    if [[ -z "$gpu_type" ]]; then
        if lspci 2>/dev/null | grep -iq 'vga.*intel'; then
            gpu_type="iGPU"
        fi
    fi

    # Get Intel GPU usage and temp if available
    if [[ "$gpu_type" == "iGPU" ]] && [[ -d /sys/class/drm/card0 ]]; then
        # Try to get Intel GPU usage from sysfs (if available)
        if [[ -f /sys/class/drm/card0/gt_cur_freq_mhz ]]; then
            # Intel integrated - harder to get usage, so we'll show N/A
            usage="N/A"
        fi
        # Try to get temperature from hwmon
        if [[ -d /sys/class/hwmon ]]; then
            for hwmon in /sys/class/hwmon/hwmon*/name; do
                if [[ -f "$hwmon" ]] && grep -q "coretemp" "$hwmon" 2>/dev/null; then
                    local hwmon_dir=$(dirname "$hwmon")
                    temp=$(cat "$hwmon_dir"/temp1_input 2>/dev/null | awk '{print int($1/1000)}' || echo "")
                    break
                fi
            done
        fi
    fi

    if [[ -z "$gpu_type" ]]; then
        echo "󰢮 No GPU detected"
    elif [[ -n "$usage" && -n "$temp" ]]; then
        echo "󰢮 ${usage}% (${temp}°C)"
    elif [[ -n "$usage" ]]; then
        echo "󰢮 ${usage}%"
    elif [[ -n "$temp" ]]; then
        echo "󰢮 N/A (${temp}°C)"
    else
        echo "󰢮 ${gpu_type}"
    fi
}

function kkernel() {
    local kernel_version
    kernel_version=$(uname -r 2>/dev/null || echo "Unknown")
    echo "󰌽 $kernel_version"
}

function all_stats() {
    echo "$(is_media) | $(disk_usage) | $(memory_usage) | $(cpu_load) | $(bbrightness) | $(mmicrophone) | $(vvolume) | $(bbattery) | $(ggpu) | $(kkernel) | $(wifi_status) | $(tail_status) | $(date_time)"
}

function help_menu() {
    cat <<EOF
    Usage: $(basename "$0") [OPTION]

    Display system statistics for bars.

    Options:
    -h, --help      Show this help message
    cpu             Display CPU load
    mem             Display memory usage
    disk            Display disk usage
    wifi            Display WiFi connection status
    tail            Display Tailscale connection status
    date            Display date
    time            Display time
    date_time       Display date and time
    ismedia         Display recording/streaming status
    battery         Display battery status with time remaining
    volume          Display volume
    microphone      Display microphone status
    brightness      Display brightness
    gpu             Display GPU information (discrete and integrated)
    kernel          Display kernel version
    all             Display all stats (combined)
EOF
}

case "$opt" in
    cpu)        cpu_load ;;
    mem)        memory_usage ;;
    disk)       disk_usage ;;
    wifi)       wifi_status ;;
    tail)       tail_status ;;
    date)       ddate ;;
    time)       ttime ;;
    date_time)  date_time ;;
    ismedia)    is_media ;;
    battery)    bbattery ;;
    volume)     vvolume ;;
    microphone) mmicrophone ;;
    brightness) bbrightness ;;
    gpu)        ggpu ;;
    kernel)     kkernel ;;
    all)        all_stats ;;
    --help|-h)  help_menu ;;
    "")         help_menu ;; # Handle empty argument
    *)
        echo "Error: Unknown argument '${opt}'." >&2
        help_menu
        exit 1
        ;;
esac

