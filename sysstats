#!/usr/bin/env bash

set -euo pipefail

opt="${1:-}"

# Theme color definitions
declare -A COLORS
COLORS=(
    [WHITE]="#ECEFF4"
    [GREEN]="#A3BE8C"
    [YELLOW]="#EBCB8B"
    [RED]="#BF616A"
    [ORANGE]="#D08770"
    [BLUE]="#81A1C1"
    [PURPLE]="#B48EAD"
    [BG]="#2E3440"
)

# Helper function to get gradient color
function get_gradient_color() {
    local percent=$1

    if   [[ $percent -le 20 ]]; then echo "${COLORS[RED]}"
    elif [[ $percent -le 40 ]]; then echo "${COLORS[ORANGE]}"
    elif [[ $percent -le 60 ]]; then echo "${COLORS[YELLOW]}"
    else echo "${COLORS[GREEN]}"
    fi
}

function ttime() {
    date +"󰥔  %I:%M %p"
}

function ddate() {
    date +"   %A %B %d %Y"
}

function date_time() {
    date +"󰥔  %I:%M %p |   %A %B %d %Y"
}

function cpu_load() {
    local load
    load="$(awk '{print $1}' /proc/loadavg)"
    echo "  $load%"
}

function disk_usage() {
    local disk_info total used
    disk_info=$(df -h / | tail -1)
    total=$(echo "$disk_info" | awk '{print $2}')
    used=$(echo "$disk_info" | awk '{print $3}')
    echo "󰋊 $used/$total"
}

function memory_usage() {
    local used total
    used="$(free -h | awk 'NR==2 {print $3}')"
    total="$(free -h | awk 'NR==2 {print $2}')"
    echo "󰍛 $used/$total"
}

function wifi_status() {
    local current icon msg color
    current=$(iwgetid -r 2>/dev/null || true)

    if [[ -z "$current" ]]; then
        icon="󰖪"
        msg="Disconnected"
        color="${COLORS[RED]}"
    else
        icon="󰖩"
        msg="$current"
        color="${COLORS[GREEN]}"
    fi
    echo "^c${COLORS[WHITE]}^${icon} ^c${color}^${msg}^d^"
}

function tail_status() {
    local icon msg color

    if tailscale status &>/dev/null; then
        if tailscale status | grep -q "Logged out"; then
            icon="󰈂"
            msg="Not connected"
            color="${COLORS[RED]}"
        else
            icon="󰈁"
            msg="Connected"
            color="${COLORS[GREEN]}"
        fi
    else
        icon="󰈂"
        msg="Not connected"
        color="${COLORS[RED]}"
    fi
    echo "^c${COLORS[WHITE]}^${icon} ^c${color}^${msg}^d^"
}

function is_media() {
    local rec=0 stream=0 icon msg color

    [[ -f "/tmp/recpid" ]] && rec=1
    [[ -f "/tmp/streampid" ]] && stream=1

    if [[ $rec -eq 1 && $stream -eq 1 ]]; then
        icon=" 󰑊"
        msg="Recording & Streaming"
        color="${COLORS[GREEN]}"
    elif [[ $rec -eq 1 ]]; then
        icon=" 󰑊"
        msg="Recording"
        color="${COLORS[GREEN]}"
    elif [[ $stream -eq 1 ]]; then
        icon=" 󰑊"
        msg="Streaming"
        color="${COLORS[GREEN]}"
    else
        icon=" "
        msg="Idle"
        color="${COLORS[RED]}"
    fi

    echo "^c${COLORS[WHITE]}^${icon} ^c${color}^${msg}^d^"
}

function bbattery() {
    local battery_info valid_batteries active_battery_line percent status icon color

    battery_info=$(acpi -b 2>/dev/null || echo "")
    [[ -z "$battery_info" ]] && return

    valid_batteries=$(echo "$battery_info" | grep -v "Unknown" | grep -v "rate information unavailable" || true)

    if [[ -n "$valid_batteries" ]]; then
        active_battery_line=$(echo "$valid_batteries" | head -n 1)
    else
        active_battery_line=$(echo "$battery_info" | head -n 1)
    fi

    percent=$(echo "$active_battery_line" | grep -o '[0-9]\+%' | tr -d '%' || echo "0")
    status=$(echo "$active_battery_line" | cut -d: -f2 | cut -d, -f1 | xargs)

    case "$status" in
        Charging|Not\ charging)
            if   [[ $percent -ge 100 ]]; then icon="󰂅"
            elif [[ $percent -ge 90 ]];  then icon="󰂋"
            elif [[ $percent -ge 80 ]];  then icon="󰂊"
            elif [[ $percent -ge 70 ]];  then icon="󰢞"
            elif [[ $percent -ge 60 ]];  then icon="󰂉"
            elif [[ $percent -ge 50 ]];  then icon="󰢝"
            elif [[ $percent -ge 40 ]];  then icon="󰂈"
            elif [[ $percent -ge 30 ]];  then icon="󰂇"
            elif [[ $percent -ge 20 ]];  then icon="󰂆"
            elif [[ $percent -ge 10 ]];  then icon="󰢜"
            else                          icon="󰢟"
            fi
            color=$(get_gradient_color "$percent")
            ;;
        Discharging)
            if   [[ $percent -ge 100 ]]; then icon="󰁹"
            elif [[ $percent -ge 90 ]];  then icon="󰂂"
            elif [[ $percent -ge 80 ]];  then icon="󰂁"
            elif [[ $percent -ge 70 ]];  then icon="󰂀"
            elif [[ $percent -ge 60 ]];  then icon="󰁿"
            elif [[ $percent -ge 50 ]];  then icon="󰁾"
            elif [[ $percent -ge 40 ]];  then icon="󰁽"
            elif [[ $percent -ge 30 ]];  then icon="󰁼"
            elif [[ $percent -ge 20 ]];  then icon="󰁻"
            elif [[ $percent -ge 10 ]];  then icon="󰁺"
            else                          icon="󰂎"
            fi
            color=$(get_gradient_color "$percent")
            ;;
        Full)
            icon="󰂄"
            color="${COLORS[GREEN]}"
            ;;
        *)
            icon="󰂑"
            color="${COLORS[WHITE]}"
            ;;
    esac

    echo "^c${COLORS[WHITE]}^${icon} ^c${color}^${percent}%^d^"
}

function vvolume() {
    local vol muted icon color msg

    vol="$(pamixer --get-volume 2>/dev/null || echo "0")"
    muted=$(pamixer --get-mute 2>/dev/null || echo "false")

    if [[ "$muted" == "true" || "$vol" -eq 0 ]]; then
        icon="󰝟"
        color="${COLORS[RED]}"
        msg="Muted"
    elif [[ "$vol" -eq 100 ]]; then
        icon="󰶬"
        color="${COLORS[GREEN]}"
        msg="${vol}%"
    elif [[ "$vol" -ge 75 ]]; then
        icon="󰕾"
        color="${COLORS[GREEN]}"
        msg="${vol}%"
    elif [[ "$vol" -ge 50 ]]; then
        icon="󰕾"
        color="${COLORS[YELLOW]}"
        msg="${vol}%"
    elif [[ "$vol" -ge 25 ]]; then
        icon="󰖀"
        color="${COLORS[ORANGE]}"
        msg="${vol}%"
    else
        icon="󰕿"
        color="${COLORS[RED]}"
        msg="${vol}%"
    fi

    echo "^c${COLORS[WHITE]}^${icon} ^c${color}^${msg}^d^"
}

function mmicrophone() {
    local vol muted icon color msg

    vol="$(pamixer --default-source --get-volume 2>/dev/null || echo 0)"
    muted="$(pamixer --default-source --get-mute 2>/dev/null || echo false)"

    if [[ "$muted" == "false" || "$vol" -gt 0 ]]; then
        icon=""
    fi

    if [[ "$muted" == "true" || "$vol" -eq 0 ]]; then
        icon=""
        color="${COLORS[RED]}"
        msg="Muted"
    elif [[ "$vol" -ge 75 ]]; then
        color="${COLORS[GREEN]}"
        msg="${vol}%"
    elif [[ "$vol" -ge 50 ]]; then
        color="${COLORS[YELLOW]}"
        msg="${vol}%"
    elif [[ "$vol" -ge 25 ]]; then
        color="${COLORS[ORANGE]}"
        msg="${vol}%"
    else
        color="${COLORS[RED]}"
        msg="${vol}%"
    fi

    echo "^c${COLORS[WHITE]}^${icon} ^c${color}^${msg}^d^"
}

function bbrightness() {
    local brightness_raw max_brightness brightness icon color

    brightness_raw=$(cat /sys/class/backlight/*/brightness 2>/dev/null || echo "0")
    max_brightness=$(cat /sys/class/backlight/*/max_brightness 2>/dev/null || echo "100")

    [[ -z "$brightness_raw" || -z "$max_brightness" || "$max_brightness" -eq 0 ]] && brightness=0 || \
        brightness=$(( (brightness_raw * 100 + max_brightness / 2) / max_brightness ))


    color=$(get_gradient_color "$brightness")

    if   [[ "$brightness" -ge 100 ]]; then icon="󰛨"
    elif [[ "$brightness" -ge 90 ]];  then icon="󱩖"
    elif [[ "$brightness" -ge 80 ]];  then icon="󱩖"
    elif [[ "$brightness" -ge 70 ]];  then icon="󱩕"
    elif [[ "$brightness" -ge 60 ]];  then icon="󱩔"
    elif [[ "$brightness" -ge 50 ]];  then icon="󱩓"
    elif [[ "$brightness" -ge 40 ]];  then icon="󱩒"
    elif [[ "$brightness" -ge 30 ]];  then icon="󱩑"
    elif [[ "$brightness" -ge 20 ]];  then icon="󱩐"
    elif [[ "$brightness" -ge 10 ]];  then icon="󱩏"
    else icon="󱩎"
    fi

    echo "^c${COLORS[WHITE]}^${icon} ^c${color}^${brightness}%^d^"
}

function all_stats() {
    echo "$(is_media) | $(disk_usage) | $(memory_usage) | $(cpu_load) | $(bbrightness) | $(mmicrophone) |  $(vvolume) | $(bbattery) | $(wifi_status) | $(tail_status) | $(date_time)"
}

function help_menu() {
    cat <<EOF
	Usage: $(basename "$0") [OPTION]

	Display system statistics for dwmblocks-async.

	Options:
	-h, --help  Show this help message
	cpu         Display CPU load
	mem         Display memory usage
	disk        Display disk usage
	wifi        Display WiFi connection status
	tail        Display Tailscale connection status
	date        Display date
	time        Display time
	date_time   Display date and time
	ismedia     Display recording/streaming status
	battery     Display battery status
	volume      Display volume
	brightness  Display brightness
	all         Display all stats (combined)
EOF
}

case "$opt" in
    cpu)        cpu_load ;;
    mem)        memory_usage ;;
    disk)       disk_usage ;;
    wifi)       wifi_status ;;
    tail)       tail_status ;;
    date)       ddate ;;
    time)       ttime ;;
    date_time)  date_time ;;
    ismedia)    is_media ;;
    battery)    bbattery ;;
    volume)     vvolume ;;
    microphone) mmicrophone ;;
    brightness) bbrightness ;;
    all)        all_stats ;;
    --help|-h)  help_menu ;;
    *)
        echo "Error: Unknown argument '${opt:- }'." >&2
        help_menu
        exit 1
        ;;
esac
