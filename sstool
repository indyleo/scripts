#!/bin/env bash

# Required binaries
deps=(grim slurp wl-copy notify-send magick jq hyprctl)
RED=$(tput setaf 1)
RESET=$(tput sgr0)

missing=()
for cmd in "${deps[@]}"; do
    command -v "$cmd" &>/dev/null || missing+=("$cmd")
done

if (( ${#missing[@]} )); then
    echo "Missing dependencies. Please install: ${missing[*]}"
    exit 1
fi

SAVE_DIR="${HOME}/Pictures/Screenshots"
mkdir -p "$SAVE_DIR"
timestamp=$(date +"%Y-%m-%d_%H-%M-%S")
filename="${SAVE_DIR}/${timestamp}.png"

function finalize() {
    if [ -f "$1" ]; then
        wl-copy < "$1"
        notify-send "Screenshot Captured" "Saved to: $(basename "$1")" -i "$1"
    fi
}

function selection() {
    grim -g "$(slurp -b '#00000044' -c '#ffffff' -s '#ffffff11')" "$filename"
    finalize "$filename"
}

function full() {
    grim "$filename"
    finalize "$filename"
}

function window() {
    # Get the active window geometry from hyprctl
    # We parse the 'at' (x,y) and 'size' (w,h) fields
    window_geom=$(hyprctl activewindow -j | jq -r '"\(.at[0]),\(.at[1]) \(.size[0])x\(.size[1])"')

    if [ "$window_geom" == "0,0 0x0" ]; then
        notify-send "Error" "No active window detected."
        exit 1
    fi

    grim -g "$window_geom" "$filename"
    finalize "$filename"
}

function screen() {
    # Captures the monitor currently focused
    monitor_name=$(hyprctl monitors -j | jq -r '.[] | select(.focused == true) | .name')
    grim -o "$monitor_name" "$filename"
    finalize "$filename"
}

function colorpicker() {
    # hyprpicker is actually the best tool for this, but using grim/magick for compatibility
    color=$(grim -g "$(slurp -p)" -t ppm - | magick - -format '%[pixel:p{0,0}]' txt:- | grep -E -o '#[0-9A-Fa-f]{6}')
    if [ -n "$color" ]; then
        echo "$color" | wl-copy
        notify-send "Color Picked" "$color copied to clipboard."
    fi
}

case "$1" in
    --select|-s) selection ;;
    --window|-w) window ;;
    --full|-f)   full ;;
    --screen|-sc) screen ;;
    --colorpicker|-c) colorpicker ;;
    *) echo "Usage: $0 {--select|--window|--full|--screen|--colorpicker}" ;;
esac
