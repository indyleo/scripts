#!/usr/bin/env bash
set -euo pipefail

# Constants
SCRIPT_NAME=$(basename "$0")
# Check required commands
DEPS=(brightnessctl wpctl nmcli bluetoothctl awk notify-send)
for cmd in "${DEPS[@]}"; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: Required command '$cmd' is not installed." >&2
        exit 1
    fi
done

# Arguments
subsys="${1:-}"
action="${2:-}"
amount="${3:-5}" # Default step is 5%

# Validate numeric argument (amount)
if [[ "$amount" =~ ^-?[0-9]+$ ]]; then
    # Ensure positive number
    amount=${amount#-}
else
    echo "Error: Amount must be an integer. Got '$amount'." >&2
    exit 1
fi

# --- Helper Functions ---

# Run command and report
function run_cmd() {
    if "$@"; then
        echo "✅ Success: $*"
    else
        echo "❌ Failed: $*" >&2
        exit 1
    fi
}

# --- Audio (wpctl) Logic ---

# Get current volume as integer (0-100)
function get_volume_percent() {
    local target="$1"
    # wpctl get-volume output example: "Volume: 0.45 [MUTED]"
    local vol_float
    vol_float=$(wpctl get-volume "$target" | awk '{print $2}')
    echo "$vol_float * 100" | awk '{printf "%d", $0}'
}

function adjust_volume() {
    local target="$1" # @DEFAULT_AUDIO_SINK@ or @DEFAULT_AUDIO_SOURCE@
    local direction="$2" # "inc" or "dec"
    local limit="$3"     # Max volume (1.0 for sink, maybe higher for mic)

    # Convert percentage (5) to decimal (0.05)
    local step
    step=$(awk "BEGIN {print $amount/100}")

    # Construct the command
    if [[ "$direction" == "inc" ]]; then
        # Check limit for sink to prevent distortion (>100%)
        if [[ "$limit" == "1.0" ]]; then
            run_cmd wpctl set-volume "$target" "${step}+" --limit 1.0
        else
            run_cmd wpctl set-volume "$target" "${step}+"
        fi
    else
        run_cmd wpctl set-volume "$target" "${step}-"
    fi

    # Notify
    local new_vol
    new_vol=$(get_volume_percent "$target")
    local type="Volume"
    [[ "$target" == "@DEFAULT_AUDIO_SOURCE@" ]] && type="Mic"
}

function toggle_mute() {
    local target="$1"
    run_cmd wpctl set-mute "$target" toggle

    local status
    status=$(wpctl get-volume "$target" | grep -q "MUTED" && echo "Muted" || echo "Unmuted")
    local type="Audio"
    [[ "$target" == "@DEFAULT_AUDIO_SOURCE@" ]] && type="Microphone"

}

# --- Brightness Logic ---

function adjust_brightness() {
    local direction="$1" # "+" or "-"
    run_cmd brightnessctl set "${amount}%${direction}"

    # Get new percentage safely
    local current_max current_val percent
    current_val=$(brightnessctl get)
    current_max=$(brightnessctl max)
    percent=$(( current_val * 100 / current_max ))

}

# --- Network/Radio Logic ---

function wifi_toggle() {
    local state
    state=$(nmcli radio wifi)
    if [[ "$state" == "enabled" ]]; then
        run_cmd nmcli radio wifi off
    else
        run_cmd nmcli radio wifi on
    fi
}

function bt_toggle() {
    local state
    # reliable way to check power state
    state=$(bluetoothctl show | grep "Powered: yes")
    if [[ -n "$state" ]]; then
        run_cmd bluetoothctl power off
    else
        run_cmd bluetoothctl power on
    fi
}

function airplane_toggle() {
    # If ANY radio is on, turn everything OFF. Otherwise, turn ON.
    local wifi_state bt_state
    wifi_state=$(nmcli radio wifi)
    bt_state=$(bluetoothctl show | grep -c "Powered: yes" || true)

    if [[ "$wifi_state" == "enabled" || "$bt_state" -eq 1 ]]; then
        nmcli radio wifi off
        bluetoothctl power off
        echo "✅ Airplane Mode ON"
    else
        nmcli radio wifi on
        bluetoothctl power on
        echo "✅ Airplane Mode OFF"
    fi
}

# --- Menus ---

function global_help() {
    cat <<EOF
Usage: $SCRIPT_NAME SUBSYSTEM ACTION [AMOUNT]

Subsystems:
  bri, brightness     Screen brightness
  vol, volume         System volume
  mic                 Microphone volume
  wifi                Wi-Fi toggle
  bt                  Bluetooth toggle
  airplane            Airplane mode toggle

Examples:
  $SCRIPT_NAME vol --inc 5
  $SCRIPT_NAME bri -d 10
  $SCRIPT_NAME wifi --toggle
EOF
}

# --- Dispatcher ---

case "$subsys" in
    bri|brightness)
        case "$action" in
            --inc|-i) adjust_brightness "+" ;;
            --dec|-d) adjust_brightness "-" ;;
            --help|-h) global_help ;;
            *) echo "Invalid brightness action. Use --inc or --dec." >&2; exit 1 ;;
        esac
        ;;
    vol|volume)
        case "$action" in
            --inc|-i) adjust_volume "@DEFAULT_AUDIO_SINK@" "inc" "1.0" ;;
            --dec|-d) adjust_volume "@DEFAULT_AUDIO_SINK@" "dec" "1.0" ;;
            --toggle) toggle_mute "@DEFAULT_AUDIO_SINK@" ;;
            --help|-h) global_help ;;
            *) echo "Invalid volume action." >&2; exit 1 ;;
        esac
        ;;
    mic)
        case "$action" in
            --inc|-i) adjust_volume "@DEFAULT_AUDIO_SOURCE@" "inc" "no-limit" ;;
            --dec|-d) adjust_volume "@DEFAULT_AUDIO_SOURCE@" "dec" "no-limit" ;;
            --toggle) toggle_mute "@DEFAULT_AUDIO_SOURCE@" ;;
            *) echo "Invalid mic action." >&2; exit 1 ;;
        esac
        ;;
    wifi)
        [[ "$action" == "--toggle" ]] && wifi_toggle || global_help
        ;;
    bt)
        [[ "$action" == "--toggle" ]] && bt_toggle || global_help
        ;;
    airplane)
        [[ "$action" == "--toggle" ]] && airplane_toggle || global_help
        ;;
    help|-h|"")
        global_help
        ;;
    *)
        echo "Error: Unknown subsystem '$subsys'." >&2
        global_help
        exit 1
        ;;
esac
