#!/bin/env bash
set -euo pipefail

# Check required commands (pamixer replaced by wpctl)
for cmd in brightnessctl wpctl nmcli bluetoothctl; do
    if ! command -v "$cmd" &>/dev/null; then
        echo "Error: $cmd is not installed."
        exit 1
    fi
done

# Constants
script_name=$(basename "$0")

# Arguments
subsys="${1:-}"
action="${2:-}"
num="${3:-5}"

# Validate numeric argument
if [[ "$action" =~ ^(--inc|-i|--dec|-d)$ ]]; then
    if ! [[ "$num" =~ ^[0-9]+$ ]]; then
        echo "Error: NUM must be a positive integer. Got '$num'."
        exit 1
    fi
fi

# Helper: run command and report success/failure
function run_and_check() {
    if "$@"; then
        echo "✅ Success: $*"
    else
        echo "❌ Failed: $*"
        exit 1
    fi
}

# --- Audio Helpers (wpctl) ---
# wpctl uses 0.01-1.0 format, so we convert your NUM (percentage) to decimal
# @DEFAULT_AUDIO_SINK@ and @DEFAULT_AUDIO_SOURCE@ are special aliases in wpctl
val_decimal=$(awk "BEGIN {print $num/100}")

# Brightness
function brightness_inc() { run_and_check brightnessctl set "${num}%+"; }
function brightness_dec() { run_and_check brightnessctl set "${num}%-"; }

# Volume (Sink)
# UPDATED: Added --limit 1.0 to ensure volume does not exceed 100%
function volume_inc() { run_and_check wpctl set-volume @DEFAULT_AUDIO_SINK@ "${val_decimal}+" --limit 1.0; }
function volume_dec() { run_and_check wpctl set-volume @DEFAULT_AUDIO_SINK@ "${val_decimal}-"; }
function volume_togglemute() { run_and_check wpctl set-mute @DEFAULT_AUDIO_SINK@ toggle; }

# Microphone (Source)
function mic_inc() { run_and_check wpctl set-volume @DEFAULT_AUDIO_SOURCE@ "${val_decimal}+"; }
function mic_dec() { run_and_check wpctl set-volume @DEFAULT_AUDIO_SOURCE@ "${val_decimal}-"; }
function mic_toggle() { run_and_check wpctl set-mute @DEFAULT_AUDIO_SOURCE@ toggle; }

# Wi-Fi
function wifi_toggle() {
    state=$(nmcli radio wifi)
    [[ "$state" == "enabled" ]] && run_and_check nmcli radio wifi off || run_and_check nmcli radio wifi on
}

# Bluetooth
function bt_toggle() {
    state=$(bluetoothctl show | grep "Powered:" | awk '{print $2}')
    [[ "$state" == "yes" ]] && run_and_check bluetoothctl power off || run_and_check bluetoothctl power on
}

# Airplane mode
function airplane_toggle() {
    state=$(nmcli radio all | grep -m1 "enabled" && echo "enabled" || echo "disabled")
    [[ "$state" == "enabled" ]] && run_and_check nmcli radio all off || run_and_check nmcli radio all on
}

# Global help menu
function global_help() {
    cat <<EOF
    Usage: $script_name SUBSYSTEM ACTION [NUM]

    Available subsystems:
    bri|brightness      Screen brightness
    vol|volume          System volume
    mic                 Microphone
    wifi                Wi-Fi
    bt                  Bluetooth
    airplane            Airplane mode

    For subsystem-specific help:
    $script_name SUBSYSTEM --help
EOF
}

# Subsystem-specific help menus
function brightness_help() {
    cat <<EOF
    Brightness (bri) controls:
    --inc | -i NUM      Increase brightness by NUM (default 5)
    --dec | -d NUM      Decrease brightness by NUM (default 5)
    --help              Show this menu
EOF
}

function volume_help() {
    cat <<EOF
    Volume (vol) controls:
    --inc | -i NUM      Increase volume by NUM (default 5, max 100%)
    --dec | -d NUM      Decrease volume by NUM (default 5)
    --toggle            Toggle mute/unmute
    --help              Show this menu
EOF
}

function mic_help() {
    cat <<EOF
    Microphone (mic) controls:
    --inc | -i NUM      Increase mic volume by NUM (default 5)
    --dec | -d NUM      Decrease mic volume by NUM (default 5)
    --toggle            Toggle mic mute/unmute
    --help              Show this menu
EOF
}

function wifi_help() {
    cat <<EOF
    Wi-Fi controls:
    --toggle            Toggle Wi-Fi on/off
    --help              Show this menu
EOF
}

function bt_help() {
    cat <<EOF
    Bluetooth (bt) controls:
    --toggle            Toggle Bluetooth on/off
    --help              Show this menu
EOF
}

function airplane_help() {
    cat <<EOF
    Airplane mode controls:
    --toggle            Toggle airplane mode on/off (disables/enables Wi-Fi & Bluetooth)
    --help              Show this menu
EOF
}


# Dispatch
case "$subsys" in
    bri|brightness)
        case "$action" in
            --inc|-i) brightness_inc ;;
            --dec|-d) brightness_dec ;;
            --help|-h) brightness_help ;;
            *) echo "Invalid action"; brightness_help; exit 1 ;;
        esac
        ;;
    vol|volume)
        case "$action" in
            --inc|-i) volume_inc ;;
            --dec|-d) volume_dec ;;
            --toggle) volume_togglemute ;;
            --help|-h) volume_help ;;
            *) echo "Invalid action"; volume_help; exit 1 ;;
        esac
        ;;
    mic)
        case "$action" in
            --inc|-i) mic_inc ;;
            --dec|-d) mic_dec ;;
            --toggle) mic_toggle ;;
            --help|-h) mic_help ;;
            *) echo "Invalid action"; mic_help; exit 1 ;;
        esac
        ;;
    wifi)
        case "$action" in
            --toggle) wifi_toggle ;;
            --help|-h) wifi_help ;;
            *) echo "Invalid action"; wifi_help; exit 1 ;;
        esac
        ;;
    bt)
        case "$action" in
            --toggle) bt_toggle ;;
            --help|-h) bt_help ;;
            *) echo "Invalid action"; bt_help; exit 1 ;;
        esac
        ;;
    airplane)
        case "$action" in
            --toggle) airplane_toggle ;;
            --help|-h) airplane_help ;;
            *) echo "Invalid action"; airplane_help; exit 1 ;;
        esac
        ;;
    help|-h|"") global_help ;;
    *) echo "Invalid subsystem '$subsys'"; global_help; exit 1 ;;
esac
