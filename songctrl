#!/usr/bin/env bash

set -euo pipefail

# Check if playerctl is installed
if ! command -v playerctl &>/dev/null; then
    echo "Error: playerctl not found. Please install it first." >&2
    exit 1
fi

readonly DEFAULT_PLAYER="SubsonicTUI"
readonly DEFAULT_CUTPOINT=25

opt="${1:-}"
player="${2:-$DEFAULT_PLAYER}"
cutpoint="${3:-$DEFAULT_CUTPOINT}"

# Validate cutpoint is a number
if ! [[ "$cutpoint" =~ ^[0-9]+$ ]]; then
    echo "Error: CUTPOINT must be a positive integer, got: $cutpoint" >&2
    exit 1
fi

function song_togglepause() {
    if playerctl -l 2>/dev/null | grep -q "^$player"; then
        playerctl play-pause --player="$player"
    else
        echo "Error: Player '$player' not found" >&2
        exit 1
    fi
}

function song_skip() {
    if playerctl -l 2>/dev/null | grep -q "^$player"; then
        playerctl next --player="$player"
    else
        echo "Error: Player '$player' not found" >&2
        exit 1
    fi
}

function song_previous() {
    if playerctl -l 2>/dev/null | grep -q "^$player"; then
        playerctl previous --player="$player"
    else
        echo "Error: Player '$player' not found" >&2
        exit 1
    fi
}

function song_title() {
    local title_status title clean_cut

    # Check if player exists
    if ! playerctl -l 2>/dev/null | grep -q "^$player"; then
        echo "Player Not Found"
        return
    fi

    title_status=$(playerctl status --player="$player" 2>/dev/null || echo "")

    if [[ "$title_status" == "Playing" ]]; then
        title=$(playerctl metadata title --player="$player" 2>/dev/null || echo "Unknown")

        if (( cutpoint > 0 )) && (( ${#title} > cutpoint )); then
            # Improved truncation - cut at word boundary
            local truncated="${title:0:$cutpoint}"
            clean_cut=$(echo "$truncated" | sed -E 's/[[:space:]]+[^[:space:]]*$//')

            # If sed removed everything, just use the truncated version
            [[ -z "$clean_cut" ]] && clean_cut="$truncated"
            echo "$clean_cut..."
        else
            echo "$title"
        fi
    else
        echo "Not Playing/Paused"
    fi
}

function song_state() {
    local song_status

    # Check if player exists
    if ! playerctl -l 2>/dev/null | grep -q "^$player"; then
        echo ""
        return
    fi

    song_status=$(playerctl status --player="$player" 2>/dev/null || echo "")

    case "$song_status" in
        Playing)
            echo " "
            ;;
        Paused)
            echo " "
            ;;
        Stopped)
            echo " "
            ;;
        *)
            # Player exists but status unknown
            echo " "
            ;;
    esac
}

function song_state_title() {
    local state title
    state=$(song_state)
    title=$(song_title)
    echo "$state$title"
}

function list_players() {
    local active_players
    active_players=$(playerctl -l 2>/dev/null || echo "")

    if [[ -z "$active_players" ]]; then
        echo "No active players found"
    else
        echo "Active players:"
        echo "$active_players"
    fi
}

function song_info() {
    local title artist album

    if ! playerctl -l 2>/dev/null | grep -q "^$player"; then
        echo "Player '$player' not found"
        return 1
    fi

    title=$(playerctl metadata title --player="$player" 2>/dev/null || echo "Unknown")
    artist=$(playerctl metadata artist --player="$player" 2>/dev/null || echo "Unknown")
    album=$(playerctl metadata album --player="$player" 2>/dev/null || echo "Unknown")

    echo "Title:  $title"
    echo "Artist: $artist"
    echo "Album:  $album"
}

function help_menu() {
    cat <<EOF
Usage: $(basename "$0") [OPTION] [PLAYER] [CUTPOINT]

Control music player playback via playerctl.

Options:
  --help, -h          Show this help message
  --togglepause, -tp  Toggle play/pause
  --skip, -s          Skip to next track
  --previous, -p      Go to previous track
  --songtitle, -st    Show current song title (truncated at CUTPOINT)
  --songstate, -ss    Show song state icon
  --songstatetitle, -sst  Show song state icon and title
  --list, -l          List all active players
  --info, -i          Show detailed song information

Arguments:
  PLAYER              Player name (default: $DEFAULT_PLAYER)
  CUTPOINT            Maximum title length before truncation (default: $DEFAULT_CUTPOINT)
                      Set to 0 to disable truncation

Examples:
  $(basename "$0") -st               Show title for default player
  $(basename "$0") -st spotify 30    Show Spotify title, max 30 chars
  $(basename "$0") -tp mpd           Toggle pause for MPD
  $(basename "$0") -l                List all active players
  $(basename "$0") -i spotify        Show detailed info for Spotify

Icon Legend:
   Playing    Paused    Stopped    Unknown/Error
EOF
}

case "$opt" in
    --togglepause|-tp)
        song_togglepause ;;
    --skip|-s)
        song_skip ;;
    --previous|-p)
        song_previous ;;
    --songtitle|-st)
        song_title ;;
    --songstate|-ss)
        song_state ;;
    --songstatetitle|-sst)
        song_state_title ;;
    --list|-l)
        list_players ;;
    --info|-i)
        song_info ;;
    --help|-h)
        help_menu ;;
    *)
        echo "Error: '${opt:- }' is an invalid option." >&2
        help_menu
        exit 1 ;;
esac
