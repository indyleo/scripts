#!/bin/env bash

set -euo pipefail

# === Functions ===

update_system() {
    echo -e "\nğŸ”„ Updating APT packages..."
    sudo apt-get update && sudo apt-get upgrade -y && sudo apt-get autoremove -y
}

update_flatpak() {
    if command -v flatpak &>/dev/null; then
        echo -e "\nğŸ“¦ Updating Flatpak..."
        flatpak update -y
    fi
}

update_rust() {
    if command -v rustup &>/dev/null; then
        echo -e "\nğŸ¦€ Updating Rust..."
        rustup update
    fi
}

update_bob() {
    if command -v bob &>/dev/null; then
        echo -e "\nğŸ›ï¸ Updating Bob..."
        bob update
    fi
}

update_pipx() {
    if command -v pipx &>/dev/null; then
        echo -e "\nğŸ Updating pipx..."
        pipx upgrade-all
    fi
}

update_luarocks() {
    if command -v luarocks &>/dev/null; then
        echo -e "\nğŸŒ Updating LuaRocks..."
        sudo luarocks update
    fi
}

update_neovim() {
    if command -v nvim &>/dev/null; then
        echo -e "\nğŸ’¡ Updating Neovim plugins..."
        nvim --headless "+Lazy! sync" +qa
    fi
}

update_tmux_plugins() {
    TPM="$HOME/.tmux/plugins/tpm/bin/update_plugins"
    if [ -x "$TPM" ]; then
        echo -e "\nğŸ”§ Updating tmux plugins..."
        "$TPM" all
    else
        echo "â— TPM not found at $TPM"
    fi
}

reload_tmux_config() {
    if [ -n "$TMUX" ]; then
        tmux source-file "${XDG_CONFIG_HOME:-$HOME/.config}/tmux/tmux.conf"
        echo "â™»ï¸ Reloaded tmux config"
    else
        echo "â„¹ï¸ Not inside a tmux session."
    fi
}

# === Menu ===

main_menu() {
    echo -e "ğŸ”„ System Update\nğŸ“¦ Flatpak Update\nğŸ¦€ Rustup Update\nğŸ›ï¸ Bob Update\nğŸ pipx Update\nğŸŒ LuaRocks Update\nğŸ’¡ Neovim Plugin Update\nğŸ”§ Tmux Plugin Update\nâ™»ï¸ Reload Tmux Config\nâœ… Run All\nâŒ Exit" | fzf --prompt="Dashboard > "
}

# === Run Loop ===

while true; do
    case "$(main_menu)" in
        "ğŸ”„ System Update") update_system ;;
        "ğŸ“¦ Flatpak Update") update_flatpak ;;
        "ğŸ¦€ Rustup Update") update_rust ;;
        "ğŸ›ï¸ Bob Update") update_bob ;;
        "ğŸ pipx Update") update_pipx ;;
        "ğŸŒ LuaRocks Update") update_luarocks ;;
        "ğŸ’¡ Neovim Plugin Update") update_neovim ;;
        "ğŸ”§ Tmux Plugin Update") update_tmux_plugins ;;
        "â™»ï¸ Reload Tmux Config") reload_tmux_config ;;
        "âœ… Run All")
            update_system
            update_flatpak
            update_rust
            update_bob
            update_pipx
            update_luarocks
            update_neovim
            update_tmux_plugins
            reload_tmux_config
            ;;
        "âŒ Exit") break ;;
    esac
    echo -e "\nâœ… Done. Press Enter to return to the dashboard..."
    read -r
done
