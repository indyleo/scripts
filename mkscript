#!/bin/env bash

set -euo pipefail

SCRIPTS_DIR="$HOME/Scripts"
mkdir -p "$SCRIPTS_DIR"

# Defaults
template="ask"      # "basic" or "advanced"
language="ask"      # "bash" or "python"
open_in_editor=true
script_name=""

usage() {
    cat << 'EOF'
Usage: mkscript [OPTIONS] [NAME]

Create or open a script in ~/Scripts.

Options:
  -b, --basic          Create a basic script template
  -a, --advanced       Create a script with help/arg parsing
  -l, --lang LANG      Language (bash/sh/shell or python3/python/py)
  -n, --noedit         Do not open in editor after creation
  -h, --help           Show this help message

Examples:
  mkscript mytool.sh               # Interactive Bash
  mkscript -b cleanup.sh           # Basic Bash template
  mkscript -a runner.sh            # Advanced Bash template
  mkscript -a -l python3 test.py   # Advanced Python
EOF
}

# --- Parse arguments ---
while [[ $# -gt 0 ]]; do
    case "$1" in
        -b|--basic)
            template="basic"
            ;;
        -a|--advanced)
            template="advanced"
            ;;
        -l|--lang)
            shift
            if [[ $# -eq 0 ]]; then
                echo "‚ùå Error: --lang requires an argument"
                exit 1
            fi
            case "$1" in
                bash|sh|shell) language="bash" ;;
                python3|python|py) language="python" ;;
                *)
                    echo "‚ùå Unknown language: $1"
                    exit 1
                    ;;
            esac
            ;;
        -n|--noedit)
            open_in_editor=false
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        -*)
            echo "‚ùå Unknown option: $1"
            usage
            exit 1
            ;;
        *)
            script_name="$1"
            ;;
    esac
    shift
done

# --- Get script name if missing ---
if [[ -z "$script_name" ]]; then
    printf "File Name: "
    read -r script_name
    if [[ -z "$script_name" ]]; then
        echo "‚ùå Error: No filename provided."
        exit 1
    fi
fi

file_path="$SCRIPTS_DIR/$script_name"

# --- Ask language if not specified ---
if [[ "$language" == "ask" ]]; then
    echo
    echo "Select language:"
    echo "  1) Bash"
    echo "  2) Python"
    printf "Choice [1-2]: "
    read -r lang_choice
    if [[ "$lang_choice" == "2" ]]; then
        language="python"
    else
        language="bash"
    fi
fi

# --- Create or open file ---
if [[ -e "$file_path" ]]; then
    echo "üìÇ Opening existing script: $file_path"
else
    echo "üÜï Creating new script: $file_path"

    # If no template flag, ask interactively
    if [[ "$template" == "ask" ]]; then
        echo
        echo "Select script type:"
        echo "  1) Basic script"
        echo "  2) Script with help menu and argument parsing"
        printf "Choice [1-2]: "
        read -r choice
        if [[ "$choice" == "2" ]]; then
            template="advanced"
        else
            template="basic"
        fi
    fi

    # --- Generate template content ---
    if [[ "$language" == "bash" ]]; then
        basic_template='#!/bin/env bash

set -euo pipefail

# Your code here
echo "Hello from Bash basic script!"
'

        advanced_template="#!/bin/env bash

set -euo pipefail

opt=\"\${1:-}\"

help_menu() {
    cat << EOF

Usage: \$(basename \"\$0\") [OPTION]

Options:
  -h, --help        Show this help message

EOF
}

case \"\$opt\" in
    -h|--help)
        help_menu
        ;;
    \"\")
        echo \"Hello from Bash advanced script!\"
        ;;
    *)
        echo \"‚ùå Error: \${opt} is not a valid option.\"
        help_menu
        exit 1
        ;;
esac
"

    else
        # Python templates
        basic_template='#!/usr/bin/env python3
"""
Basic Python script template.
"""

def main():
    """Main function."""
    print("Hello from Python basic script!")

if __name__ == "__main__":
    main()
'

        advanced_template='#!/usr/bin/env python3
"""
Advanced Python script template with argument parsing.
"""

import argparse
import sys

def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(description="Description of your script")
    parser.add_argument("--example", help="Example argument")
    return parser.parse_args()

def main():
    """Main function."""
    args = parse_args()
    if args.example:
        print(f"Example arg: {args.example}")
    else:
        print("Hello from Python advanced script!")

if __name__ == "__main__":
    main()
'
    fi

    # Write template
    if [[ "$template" == "advanced" ]]; then
        printf "%s" "$advanced_template" > "$file_path"
    else
        printf "%s" "$basic_template" > "$file_path"
    fi

    chmod +x "$file_path"
    echo "‚úÖ Created: $file_path"
fi

# --- Open in editor ---
if $open_in_editor; then
    "${EDITOR:-nvim}" "$file_path"
else
    echo "üìù Skipped opening in editor."
fi

