#!/usr/bin/env bash

set -euo pipefail

# Check if playerctl is installed
if ! command -v playerctl &> /dev/null; then
    echo "Error: playerctl is not installed." >&2
    exit 1
fi

# Preferred players in order
readonly PLAYERS=("chromium" "firefox" "brave")
readonly BROWSERS=("qutebrowser" "firefox" "brave" "chromium")

opt="${1:-}"
cutpoint="${2:-25}"

# Cache active players to avoid multiple calls
active_players=$(playerctl -l 2>/dev/null || true)

# Select the most preferred available player
function sel_player() {
    for preferred in "${PLAYERS[@]}"; do
        local match
        match=$(echo "$active_players" | grep -i "^$preferred" | head -n 1 || true)
        if [[ -n "$match" ]]; then
            echo "$match"
            return 0
        fi
    done
    return 1
}

# Get the first running browser from the preferred list
function get_running_browser() {
    for browser in "${BROWSERS[@]}"; do
        if pgrep -x "$browser" > /dev/null 2>&1; then
            echo "$browser"
            return 0
        fi
    done
    return 1
}

# Cache selected player and browser
match=$(sel_player || true)
active_browser=$(get_running_browser || true)

if [[ -z "${match:-}" ]]; then
    echo "No player found" >&2
fi

if [[ -z "${active_browser:-}" ]]; then
    echo "No browser found" >&2
fi

function browser_togglepause() {
    playerctl play-pause --player="$match"
}

function browser_skip() {
    playerctl next --player="$match"
}

function browser_previous() {
    playerctl previous --player="$match"
}

function browser_title() {
    local status title
    status=$(playerctl status --player="$match" 2>/dev/null || true)

    if [[ "$status" == "Playing" ]]; then
        title=$(playerctl metadata title --player="$match" 2>/dev/null || true)

        if [[ -n "$cutpoint" && ${#title} -gt "$cutpoint" ]]; then
            # Improved truncation - cut at word boundary
            local truncated="${title:0:$cutpoint}"
            local clean_cut
            clean_cut=$(echo "$truncated" | sed -E 's/[[:space:]]+[^[:space:]]*$//')
            [[ -z "$clean_cut" ]] && clean_cut="$truncated"
            echo "$clean_cut..."
        else
            echo "$title"
        fi
    else
        echo "Not Playing/Paused"
    fi
}

function browser_state() {
    local icon status

    case "$active_browser" in
        firefox)     icon=" " ;;
        chromium)    icon=" " ;;
        *)           icon="󰖟 " ;;
    esac

    if [[ -z "$match" ]]; then
        echo "$icon"
        return
    fi

    status=$(playerctl status --player="$match" 2>/dev/null || true)
    case "$status" in
        Playing) echo "$icon " ;;
        Paused)  echo "$icon " ;;
        Stopped) echo "$icon " ;;
        *)       echo "$icon " ;;
    esac
}

function browser_state_title() {
    local state title
    state=$(browser_state)
    title=$(browser_title)
    echo "$state $title"
}

function help_menu() {
    cat <<EOF
Usage: $(basename "$0") [OPTION] [CUTPOINT]

Control browser media playback via playerctl.

Options:
    --help, -h                 Show this help message
    --togglepause, -tp         Toggle pause media
    --skip, -s                 Skip to next track
    --previous, -p             Go to previous track
    --browsertitle, -bt        Show browser title (truncated at CUTPOINT)
    --browserstate, -bs        Show browser state icon
    --browserstatetitle, -bst  Show browser state and title

Arguments:
    CUTPOINT                   Maximum title length before truncation (default: 25)

Examples:
    $(basename "$0") -bt 30    Show title truncated at 30 characters
    $(basename "$0") -tp       Toggle play/pause
EOF
}

# Command dispatch
case "$opt" in
    --togglepause|-tp)
        browser_togglepause ;;
    --skip|-s)
        browser_skip ;;
    --previous|-p)
        browser_previous ;;
    --browsertitle|-bt)
        browser_title ;;
    --browserstate|-bs)
        browser_state ;;
    --browserstatetitle|-bst)
        browser_state_title ;;
    --help|-h)
        help_menu ;;
    *)
        echo "Error: '${opt:- }' is an invalid option." >&2
        help_menu
        exit 1 ;;
esac
