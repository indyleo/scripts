#!/usr/bin/env bash
set -euo pipefail

# =====================================
# CONFIG & PATHS
# =====================================
WALLPAPERS_DIR="$HOME/Pictures/Wallpapers"
LOG_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/desktopctl.log"
TIMEXWALR_PID_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/timexwalr.pid"

# =====================================
# COLORS & LOGGING
# =====================================
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
RESET="\033[0m"

log() {
    local level="$1"
    local msg="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $msg" >> "$LOG_FILE"
}

# =====================================
# WALLPAPER LOGIC (WAYLAND + SWWW)
# =====================================

init_swww() {
    if ! pgrep -x "swww-daemon" > /dev/null; then
        echo -e "${YELLOW}Starting swww-daemon...${RESET}"
        swww-daemon & disown
        sleep 0.7
    fi
}

wallpaper_set() {
    local DIR="$1"
    init_swww

    if [[ ! -d "$DIR" ]]; then
        echo -e "${RED}Error: Directory does not exist: $DIR${RESET}"
        return 1
    fi

    # 1. Pick random image
    local IMG
    IMG=$(find "$DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) | shuf -n 1)

    if [[ -z "$IMG" ]]; then
        echo -e "${RED}No images found in $DIR${RESET}"
        return 1
    fi

    # 2. Pick random transition
    local TRANSITIONS=(grow fade wipe left right top bottom outer wave center)
    local TT="${TRANSITIONS[RANDOM % ${#TRANSITIONS[@]}]}"

    # 3. Build command
    local CMD=(swww img "$IMG"
        --transition-type "$TT"
        --transition-duration 1.3
        --transition-fps 60
    )

    # 4. Add random coordinates for radial/growth transitions
    if [[ "$TT" =~ ^(grow|center|outer)$ ]]; then
        local POS_X="0.$(printf "%02d" $((RANDOM%80+10)))"
        local POS_Y="0.$(printf "%02d" $((RANDOM%80+10)))"
        CMD+=(--transition-pos "$POS_X,$POS_Y")
    fi

    # Execute
    "${CMD[@]}"
    echo -e "${GREEN}Wallpaper set: $(basename "$IMG") (Transition: $TT)${RESET}"
    log "INFO" "Wallpaper set to $IMG with transition $TT"
}

start_timexwalr() {
    local DIR="$1"
    local INTERVAL="${2:-900}"

    stop_timexwalr || true

    (
        while true; do
            wallpaper_set "$DIR" || true
            sleep "$INTERVAL"
        done
    ) &
    local PID=$!
    echo "$PID" > "$TIMEXWALR_PID_FILE"
    echo -e "${GREEN}Wallpaper daemon started on directory '$DIR' (PID $PID)${RESET}"
}

stop_timexwalr() {
    if [[ -f "$TIMEXWALR_PID_FILE" ]]; then
        local PID
        PID=$(cat "$TIMEXWALR_PID_FILE")
        if kill "$PID" 2>/dev/null; then
            echo -e "${YELLOW}Wallpaper daemon stopped.${RESET}"
        else
            echo -e "${RED}Daemon process $PID not found, removing lock file.${RESET}"
        fi
        rm -f "$TIMEXWALR_PID_FILE"
    else
        echo -e "${YELLOW}No wallpaper daemon running.${RESET}"
    fi
}

# =====================================
# CLI MENU
# =====================================

show_help() {
    cat <<EOF
Usage: desktopctl COMMAND [ARGS]

Commands:
  random <dir>            Set a random wallpaper immediately from <dir>
  time <dir> [seconds]    Start wallpaper cycle daemon (Default: 900s)
  stop                    Stop the wallpaper cycle daemon

Examples:
  desktopctl random ~/Pictures/Wallpapers
  desktopctl time ~/Pictures/Wallpapers/Anime 300
EOF
}

[[ $# -eq 0 ]] && { show_help; exit 0; }

COMMAND="$1"
shift || true

case "$COMMAND" in
    random)
        wallpaper_set "${1:-$WALLPAPERS_DIR}"
        ;;
    time)
        start_timexwalr "${1:-$WALLPAPERS_DIR}" "${2:-900}"
        ;;
    stop|time-stop)
        stop_timexwalr
        ;;
    -h|--help)
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $COMMAND${RESET}"
        show_help
        ;;
esac
