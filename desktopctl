#!/usr/bin/env bash
set -euo pipefail

# =====================================
# CONFIG & PATHS
# =====================================
THEME_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/theme"
HOME_CONFIG="${XDG_CONFIG_HOME:-"$HOME/.config"}"
WALLPAPERS_DIR="$HOME/Pictures/Wallpapers"
SUCKLESS_DIR="$HOME/Github/suckless"
ALACRITTY_CONFIG="$HOME_CONFIG/alacritty"
ROFI_CONFIG="$HOME_CONFIG/rofi"
VENCORD_THEME="$HOME/.var/app/dev.vencord.Vesktop/config/vesktop/themes"
DUNST_CONFIG="$HOME_CONFIG/dunst"
TMUX_CONFIG="$HOME_CONFIG/tmux"

LOG_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/desktopctl.log"
TIMEXWALR_PID_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/timexwalr.pid"

# =====================================
# COLORS & LOGGING
# =====================================
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
RESET="\033[0m"

log() {
    local level="$1"
    local msg="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $msg" >> "$LOG_FILE"
}

# =====================================
# WALLPAPER LOGIC (WAYLAND + SWWW)
# =====================================

init_swww() {
    if ! pgrep -x "swww-daemon" > /dev/null; then
        echo -e "${YELLOW}Starting swww-daemon...${RESET}"
        swww-daemon & disown
        sleep 0.7
    fi
}

wallpaper_set() {
    local DIR="$1"
    init_swww

    if [[ ! -d "$DIR" ]]; then
        echo -e "${RED}Error: Directory does not exist: $DIR${RESET}"
        return 1
    fi

    # 1. Pick random image
    local IMG
    IMG=$(find "$DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) | shuf -n 1)

    if [[ -z "$IMG" ]]; then
        echo -e "${RED}No images found in $DIR${RESET}"
        return 1
    fi

    # 2. Pick random transition
    local TRANSITIONS=(grow fade wipe left right top bottom outer wave center)
    local TT="${TRANSITIONS[RANDOM % ${#TRANSITIONS[@]}]}"

    # 3. Build command
    local CMD=(swww img "$IMG"
        --transition-type "$TT"
        --transition-duration 1.3
        --transition-fps 60
    )

    # 4. Add random coordinates for radial/growth transitions
    if [[ "$TT" =~ ^(grow|center|outer)$ ]]; then
        local POS_X="0.$(printf "%02d" $((RANDOM%80+10)))"
        local POS_Y="0.$(printf "%02d" $((RANDOM%80+10)))"
        CMD+=(--transition-pos "$POS_X,$POS_Y")
    fi

    # Execute
    "${CMD[@]}"
    echo -e "${GREEN}Wallpaper set: $(basename "$IMG") (Transition: $TT)${RESET}"
    log "INFO" "Wallpaper set to $IMG with transition $TT"
}

start_timexwalr() {
    local DIR="$1"
    local INTERVAL="${2:-900}"

    stop_timexwalr || true

    (
        while true; do
            wallpaper_set "$DIR" || true
            sleep "$INTERVAL"
        done
    ) &
    local PID=$!
    echo "$PID" > "$TIMEXWALR_PID_FILE"
    echo -e "${GREEN}Wallpaper daemon started (PID $PID)${RESET}"
}

stop_timexwalr() {
    if [[ -f "$TIMEXWALR_PID_FILE" ]]; then
        local PID
        PID=$(cat "$TIMEXWALR_PID_FILE")
        kill "$PID" 2>/dev/null || true
        rm -f "$TIMEXWALR_PID_FILE"
        echo -e "${YELLOW}Wallpaper daemon stopped.${RESET}"
    fi
}

# =====================================
# THEME SWITCHING
# =====================================

set_theme() {
    local THEME="$1"
    if [[ "$THEME" != "gruvbox" && "$THEME" != "nord" ]]; then
        echo -e "${RED}Invalid theme: $THEME${RESET}"
        exit 1
    fi

    echo -e "${BLUE}Switching to $THEME theme...${RESET}"

    # Update daemon and set first wallpaper
    start_timexwalr "${WALLPAPERS_DIR}/${THEME}" 900

    # Notification settings (Dunst)
    ln -sf "${DUNST_CONFIG}/dunstrc_${THEME}" "${DUNST_CONFIG}/dunstrc"
    pkill -x dunst || true
    dunst & disown

    # Terminal, Rofi, and Tmux
    ln -sf "${ALACRITTY_CONFIG}/alacritty_${THEME}.toml" "${ALACRITTY_CONFIG}/alacritty.toml"
    ln -sf "${ROFI_CONFIG}/themes/${THEME}.rasi" "${ROFI_CONFIG}/themes/theme.rasi"
    ln -sf "${TMUX_CONFIG}/tmux_${THEME}.conf" "${TMUX_CONFIG}/tmux.conf"

    # Discord (Vencord/Vesktop)
    mkdir -p "${VENCORD_THEME}/Themes"
    local V_THEME_FILE="${VENCORD_THEME}/Themes/midnight-${THEME}.theme.css"
    if [[ ! -f "$V_THEME_FILE" ]]; then
        wget -qO "$V_THEME_FILE" "https://raw.githubusercontent.com/indyleo/VencordThemes/refs/heads/main/midnight-${THEME}.theme.css" || true
    fi
    ln -sf "$V_THEME_FILE" "${VENCORD_THEME}/midnight.theme.css"

    # Suckless builds (Optional / XWayland)
    APPS=(dmenu dwm slock st)
    for APP in "${APPS[@]}"; do
        (
            APP_DIR="${SUCKLESS_DIR}/${APP}"
            if [[ -d "$APP_DIR" ]]; then
                cd "$APP_DIR"
                ln -sf "config_${THEME}.def.h" "config.def.h"
                sudo cp config.def.h config.h
                sudo make clean install > /dev/null 2>&1
            fi
        ) &
    done

    echo "$THEME" > "$THEME_FILE"
    echo -e "${GREEN}Theme '$THEME' applied successfully.${RESET}"
    log "INFO" "Theme switched to $THEME"
}

# =====================================
# CLI MENU
# =====================================

show_help() {
    cat <<EOF
Usage: desktopctl COMMAND [ARGS]

Commands:
  theme <gruvbox|nord>             Switch system theme and wallpaper dir
  wallpaper random <dir>           Set a random wallpaper once
  wallpaper time <dir> [s]         Start timed wallpaper daemon
  wallpaper time-stop              Stop timed wallpaper daemon
  wallpaper theme                  Set random wallpaper from current theme dir
  wallpaper theme-time [s]         Start daemon using current theme dir
EOF
}

[[ $# -eq 0 ]] && { show_help; exit 0; }

COMMAND="$1"
shift || true

case "$COMMAND" in
    theme) set_theme "${1:-}" ;;
    wallpaper)
        WP_CMD="${1:-}"
        shift || true
        case "$WP_CMD" in
            random)     wallpaper_set "${1:-$WALLPAPERS_DIR}" ;;
            time)       start_timexwalr "${1:-$WALLPAPERS_DIR}" "${2:-900}" ;;
            time-stop)  stop_timexwalr ;;
            theme)
                CUR_THEME=$(cat "$THEME_FILE" 2>/dev/null || echo "gruvbox")
                wallpaper_set "${WALLPAPERS_DIR}/$CUR_THEME"
                ;;
            theme-time)
                CUR_THEME=$(cat "$THEME_FILE" 2>/dev/null || echo "gruvbox")
                start_timexwalr "${WALLPAPERS_DIR}/$CUR_THEME" "${1:-900}"
                ;;
            *) show_help ;;
        esac
        ;;
    -h|--help) show_help ;;
    *) echo -e "${RED}Unknown command: $COMMAND${RESET}"; show_help ;;
esac
