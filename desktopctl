#!/bin/env bash
set -euo pipefail

# =====================================
# CONFIG
# =====================================
THEME_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/theme"
HOME_CONFIG="${XDG_CONFIG_HOME:-"$HOME/.config"}"
WALLPAPERS_DIR="$HOME/Pictures/Wallpapers"
SUCKLESS_DIR="$HOME/Github/suckless"
ALACRITTY_CONFIG="$HOME_CONFIG/alacritty"
DUNST_CONFIG="$HOME_CONFIG/dunst"
TMUX_CONFIG="$HOME_CONFIG/tmux"
XRESOURCES="$HOME"
STARTPAGE="$HOME/Github/portfilio/startpage/"

LOG_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/desktopctl.log"
TIMEXWALR_PID_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/timexwalr.pid"

# =====================================
# COLOR OUTPUT
# =====================================
RED="\033[1;31m"
GREEN="\033[1;32m"
YELLOW="\033[1;33m"
BLUE="\033[1;34m"
RESET="\033[0m"

# =====================================
# LOG FUNCTION
# =====================================
log() {
    local level="$1"
    local msg="$2"
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] [$level] $msg" >> "$LOG_FILE"
}

# =====================================
# HELP MENU FUNCTION
# =====================================
show_help() {
    cat <<EOF
Usage: desktopctl COMMAND [ARGS]

Commands:
  theme <gruvbox|nord>           Switch theme
  wallpaper random <dir>          Set a random wallpaper once
  wallpaper time <dir> [s]       Start timed wallpaper daemon
  wallpaper time-stop             Stop timed wallpaper daemon
  wallpaper time-restart <dir> [s]  Restart timed wallpaper daemon
  wallpaper theme                 Set wallpaper based on current theme
	wallpaper theme-time [s]        Set timed wallpaper based on current theme
  --help|-h                      Show this help menu
EOF
}

# =====================================
# WALLPAPER FUNCTIONS
# =====================================
wallpaper_xwalr() {
    local DIR="$1"
    if [[ ! -d "$DIR" ]]; then
        echo -e "${RED}Error: Directory does not exist: $DIR${RESET}"
        show_help
        exit 1
    fi
    local MONITORS=($(xrandr | grep " connected" | cut -d ' ' -f1))
    for monitor in "${MONITORS[@]}"; do
        local wp=$(find "$DIR" -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.gif' \) | shuf -n 1)
        xwallpaper --output "$monitor" --stretch "$wp"
        echo -e "${GREEN}Wallpaper set on $monitor to $wp${RESET}"
        log "INFO" "Wallpaper set on $monitor to $wp"
    done
}

start_timexwalr() {
    local DIR="$1"
    local INTERVAL="${2:-900}"

    if [[ ! -d "$DIR" ]]; then
        echo -e "${RED}Error: Directory does not exist: $DIR${RESET}"
        show_help
        exit 1
    fi

    if [[ -f "$TIMEXWALR_PID_FILE" ]] && kill -0 "$(cat "$TIMEXWALR_PID_FILE")" &>/dev/null; then
        echo -e "${YELLOW}timexwalr is already running (PID $(cat "$TIMEXWALR_PID_FILE"))${RESET}"
        exit 0
    fi

    (
        while true; do
            wallpaper_xwalr "$DIR"
            sleep "$INTERVAL"
        done
    ) &
    local PID=$!
    echo "$PID" > "$TIMEXWALR_PID_FILE"
    echo -e "${GREEN}timexwalr started (PID $PID)${RESET}"
    log "INFO" "timexwalr started on $DIR with interval $INTERVAL sec, PID $PID"
}

stop_timexwalr() {
    if [[ -f "$TIMEXWALR_PID_FILE" ]]; then
        local PID
        PID=$(cat "$TIMEXWALR_PID_FILE")
        if kill -0 "$PID" &>/dev/null; then
            kill "$PID"
            echo -e "${GREEN}timexwalr stopped (PID $PID)${RESET}"
            log "INFO" "timexwalr stopped (PID $PID)"
        else
            echo -e "${YELLOW}timexwalr PID $PID not running${RESET}"
        fi
        rm -f "$TIMEXWALR_PID_FILE"
    else
        echo -e "${YELLOW}timexwalr is not running${RESET}"
    fi
}

restart_timexwalr() {
    local DIR="$1"
    local INTERVAL="${2:-900}"
    stop_timexwalr
    start_timexwalr "$DIR" "$INTERVAL"
}

wallpaper_theme() {
    if [[ ! -f "$THEME_FILE" ]]; then
        echo -e "${RED}Error: Theme file not found at $THEME_FILE${RESET}"
        exit 1
    fi
    local THEME
    THEME=$(cat "$THEME_FILE")
    [[ "$THEME" != "gruvbox" && "$THEME" != "nord" ]] && THEME="other"
    wallpaper_xwalr "${WALLPAPERS_DIR}/${THEME}"
}

# =====================================
# THEME FUNCTIONS
# =====================================
set_theme() {
    local THEME="$1"
    if [[ "$THEME" != "gruvbox" && "$THEME" != "nord" ]]; then
        echo -e "${RED}Error: Invalid theme: $THEME${RESET}"
        show_help
        exit 1
    fi
    if [[ -f "$THEME_FILE" && "$(cat "$THEME_FILE")" == "$THEME" ]]; then
        echo -e "${YELLOW}Theme '$THEME' is already active.${RESET}"
        return
    fi

    stop_timexwalr || true
    start_timexwalr "${WALLPAPERS_DIR}/${THEME}" 900 & disown

    ln -sf "${DUNST_CONFIG}/dunstrc_${THEME}" "${DUNST_CONFIG}/dunstrc"
    pkill -x dunst || true
    dunst & disown
    echo -e "${GREEN}Dunst configured${RESET}"
    log "INFO" "Dunst configured"

    ln -sf "${ALACRITTY_CONFIG}/alacritty_${THEME}.toml" "${ALACRITTY_CONFIG}/alacritty.toml"
    ln -sf "${XRESOURCES}/.Xresources_${THEME}" "${XRESOURCES}/.Xresources"
    xrdb "${XRESOURCES}/.Xresources"
    echo -e "${GREEN}Alacritty and Xresources configured${RESET}"
    log "INFO" "Alacritty and Xresources configured"

    APPS=(dmenu dwm slock st)
    declare -a pids
    for APP in "${APPS[@]}"; do
        (
            APP_DIR="${SUCKLESS_DIR}/${APP}"
            if [[ -d "$APP_DIR" ]]; then
                echo -e "${BLUE}Building $APP...${RESET}"
                cd "$APP_DIR"
                ln -sf "config_${THEME}.def.h" "config.def.h"
                sudo cp config.def.h config.h
                sudo make clean install
                log "INFO" "$APP build finished"
                echo -e "${GREEN}$APP build finished${RESET}"
            else
                echo -e "${YELLOW}Warning: $APP directory not found at $APP_DIR${RESET}"
                log "WARN" "$APP directory not found at $APP_DIR"
            fi
        ) &
        pids+=($!)
    done
    for pid in "${pids[@]}"; do wait $pid; done

    ln -sf "${TMUX_CONFIG}/tmux_${THEME}.conf" "${TMUX_CONFIG}/tmux.conf"
    if [[ -d "$STARTPAGE" ]]; then
        echo "$THEME" > "${STARTPAGE}/theme.txt"
        echo -e "${GREEN}Startpage theme set${RESET}"
        log "INFO" "Startpage theme set"
    fi

    echo "$THEME" > "$THEME_FILE"
    if pgrep -x dwmblocks > /dev/null; then
        pkill -x dwmblocks
        dwmblocks & disown
    fi
    if ! pgrep -x dwmblocks > /dev/null; then
        dwmblocks & disown
    fi
    echo -e "${GREEN}Theme switched to $THEME${RESET}"
    log "INFO" "Theme switched to $THEME"
}

# =====================================
# MAIN CLI
# =====================================
if [[ $# -eq 0 ]]; then
    show_help
    exit 0
fi

COMMAND="$1"
shift || true

case "$COMMAND" in
    theme) set_theme "$1" ;;
    wallpaper)
        if [[ $# -eq 0 ]]; then show_help; exit 1; fi
        WP_CMD="$1"
        shift
        case "$WP_CMD" in
            random) wallpaper_random "$1" ;;
            time) wallpaper_time "$1" "${1:-900}" ;;
            time-stop) wallpaper_time_stop ;;
            time-restart) wallpaper_time_restart "$1" "${2:-900}" ;;
            theme) wallpaper_theme ;;
            theme-time)
                INTERVAL="${1:-900}"
                if [[ ! -f "$THEME_FILE" ]]; then
                    echo -e "${RED}Error: Theme file not found at $THEME_FILE${RESET}"
                    exit 1
                fi
                THEME=$(cat "$THEME_FILE")
                [[ "$THEME" != "gruvbox" && "$THEME" != "nord" ]] && THEME="other"
                start_timexwalr "${WALLPAPERS_DIR}/${THEME}" "$INTERVAL"
                ;;

            *) echo -e "${RED}Unknown wallpaper command: $WP_CMD${RESET}"; show_help ;;
        esac
        ;;
    --help|-h) show_help ;;
    *) echo -e "${RED}Unknown command: $COMMAND${RESET}"; show_help ;;
esac

