#!/usr/bin/env bash
# mediactl - Unified media player controller
# Manages browser-based media (YouTube, Spotify Web) and dedicated players (Spotify, MPD, SubsonicTUI)
# with intelligent priority-based source selection

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

readonly SCRIPT_NAME="mediactl"
readonly VERSION="1.0.0"

# Player categories - used for priority resolution
readonly BROWSER_PLAYERS=(
    "firefox"
    "chromium"
    "chrome"
    "brave"
    "plasma-browser-integration"
)

readonly SONG_PLAYERS=(
    "spotify"
    "SubsonicTUI"
    "mpd"
    "mopidy"
    "elisa"
    "rhythmbox"
)

# Cache configuration
readonly CACHE_DIR="${XDG_RUNTIME_DIR:-/tmp}/mediactl"
readonly PLAYER_LIST_CACHE="$CACHE_DIR/players"
readonly CACHE_LIFETIME=1  # seconds

# Visual indicators
readonly ICON_BROWSER="ðŸŒ"
readonly ICON_SONG="ðŸŽµ"
readonly ICON_PLAYING="â–¶"
readonly ICON_PAUSED="â¸"
readonly ICON_STOPPED="â¹"
readonly ICON_IDLE="â¹"  # Use stopped icon for idle

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

function die() {
    echo "$SCRIPT_NAME: $*" >&2
    exit 1
}

function check_dependencies() {
    if ! command -v playerctl &>/dev/null; then
        die "playerctl not found. Install it to use $SCRIPT_NAME"
    fi
}

function init_cache_dir() {
    mkdir -p "$CACHE_DIR"
}

# Check if cache file is fresh (modified within CACHE_LIFETIME seconds)
function is_cache_fresh() {
    local cache_file="$1"
    [[ -f "$cache_file" ]] || return 1

    local now mod_time age
    now=$(date +%s)
    mod_time=$(stat -c %Y "$cache_file" 2>/dev/null || echo 0)
    age=$((now - mod_time))

    [[ $age -lt $CACHE_LIFETIME ]]
}

# ============================================================================
# PLAYER DETECTION & CLASSIFICATION
# ============================================================================

# Get list of all active players (with 1-second caching)
function get_all_players() {
    if is_cache_fresh "$PLAYER_LIST_CACHE"; then
        cat "$PLAYER_LIST_CACHE"
        return 0
    fi

    local players
    players=$(playerctl -l 2>/dev/null || echo "")
    echo "$players" | tee "$PLAYER_LIST_CACHE"
}

# Determine if a player is a browser player
function is_browser_player() {
    local player="$1"
    for bp in "${BROWSER_PLAYERS[@]}"; do
        [[ "$player" == *"$bp"* ]] && return 0
    done
    return 1
}

# Determine if a player is a song player
function is_song_player() {
    local player="$1"
    for sp in "${SONG_PLAYERS[@]}"; do
        [[ "$player" == *"$sp"* ]] && return 0
    done
    return 1
}

# Get all browser players with their status
function get_browser_players() {
    local players all_players
    all_players=$(get_all_players)

    while IFS= read -r player; do
        [[ -z "$player" ]] && continue
        if is_browser_player "$player"; then
            local status
            status=$(playerctl -p "$player" status 2>/dev/null || echo "Stopped")
            echo "$player|$status"
        fi
    done <<< "$all_players"
}

# Get all song players with their status
function get_song_players() {
    local players all_players
    all_players=$(get_all_players)

    while IFS= read -r player; do
        [[ -z "$player" ]] && continue
        if is_song_player "$player"; then
            local status
            status=$(playerctl -p "$player" status 2>/dev/null || echo "Stopped")
            echo "$player|$status"
        fi
    done <<< "$all_players"
}

# ============================================================================
# PRIORITY RESOLUTION
# ============================================================================

# Implements the core priority logic:
# 1. If ANY player is Playing â†’ show it (browser takes priority)
# 2. Otherwise â†’ Idle (ignore paused/stopped players)
function get_active_player() {
    local browser_players song_players
    browser_players=$(get_browser_players)
    song_players=$(get_song_players)

    # Check for any Playing browser player
    while IFS='|' read -r player status; do
        [[ -z "$player" ]] && continue
        if [[ "$status" == "Playing" ]]; then
            echo "browser|$player|$status"
            return 0
        fi
    done <<< "$browser_players"

    # Check for any Playing song player
    while IFS='|' read -r player status; do
        [[ -z "$player" ]] && continue
        if [[ "$status" == "Playing" ]]; then
            echo "song|$player|$status"
            return 0
        fi
    done <<< "$song_players"

    # Nothing is actively playing â†’ Idle
    # (We ignore paused/stopped players entirely)
    echo "idle||Idle"
}

# ============================================================================
# METADATA RETRIEVAL
# ============================================================================

# Get metadata for a specific player
# Returns: status|title|artist|album|art_url
function get_player_metadata() {
    local player="$1"

    [[ "$player" == "idle" ]] && {
        echo "Idle||||"
        return 0
    }

    local status title artist album art_url
    status=$(playerctl -p "$player" status 2>/dev/null || echo "Stopped")
    title=$(playerctl -p "$player" metadata title 2>/dev/null || echo "Unknown")
    artist=$(playerctl -p "$player" metadata artist 2>/dev/null || echo "Unknown")
    album=$(playerctl -p "$player" metadata album 2>/dev/null || echo "")
    art_url=$(playerctl -p "$player" metadata mpris:artUrl 2>/dev/null || echo "")

    echo "$status|$title|$artist|$album|$art_url"
}

# ============================================================================
# STATE MANAGEMENT
# ============================================================================

# Get complete state of active media
# Returns: type|player|status|title|artist|album|art_url
function get_state() {
    local active_info type player status metadata
    active_info=$(get_active_player)

    IFS='|' read -r type player status <<< "$active_info"

    # For idle state, return minimal info
    if [[ "$type" == "idle" ]]; then
        echo "idle||Idle|||"
        return
    fi

    metadata=$(get_player_metadata "$player")
    echo "$type|$player|$metadata"
}

# Get status icon based on playback state
function get_status_icon() {
    local status="$1"
    case "$status" in
        Playing) echo "$ICON_PLAYING" ;;
        Paused)  echo "$ICON_PAUSED" ;;
        Stopped) echo "$ICON_STOPPED" ;;
        Idle)    echo "$ICON_IDLE" ;;
        *)       echo "" ;;
    esac
}

# Get source icon based on player type
function get_source_icon() {
    local type="$1"
    case "$type" in
        browser) echo "$ICON_BROWSER" ;;
        song)    echo "$ICON_SONG" ;;
        *)       echo "" ;;
    esac
}

# ============================================================================
# OUTPUT FORMATTING
# ============================================================================

# Format title with optional cutoff
function format_title() {
    local title="$1"
    local cutpoint="${2:-50}"

    [[ "$title" == "Unknown" || "$title" == "Idle" ]] && {
        echo "$title"
        return
    }

    if [[ ${#title} -gt $cutpoint ]]; then
        echo "${title:0:$cutpoint}â€¦"
    else
        echo "$title"
    fi
}

# ============================================================================
# CONTROL COMMANDS
# ============================================================================

# Send control command to active player
function send_control() {
    local command="$1"
    local active_info type player
    active_info=$(get_active_player)
    IFS='|' read -r type player _ <<< "$active_info"

    [[ "$player" == "idle" ]] && {
        echo "No active player" >&2
        return 1
    }

    playerctl -p "$player" "$command" 2>/dev/null || {
        echo "Failed to send $command to $player" >&2
        return 1
    }
}

# ============================================================================
# COMMAND HANDLERS
# ============================================================================

function cmd_status() {
    # Returns: type|player|status|title|artist|album|art_url
    get_state
}

function cmd_title() {
    local cutpoint="${1:-50}"
    local state title
    state=$(get_state)
    IFS='|' read -r _ _ _ title _ _ _ <<< "$state"
    format_title "$title" "$cutpoint"
}

function cmd_state() {
    # Icon-only state indicator
    local state type status
    state=$(get_state)
    IFS='|' read -r type _ status _ _ _ _ <<< "$state"

    # Only show playing icon, otherwise show idle
    if [[ "$type" == "idle" || "$status" != "Playing" ]]; then
        echo "$ICON_IDLE"
        return
    fi

    get_status_icon "$status"
}

function cmd_state_title() {
    # Combined icon + title
    local cutpoint="${1:-50}"
    local state type status title icon
    state=$(get_state)
    IFS='|' read -r type _ status title _ _ _ <<< "$state"

    # If nothing is playing (idle or non-Playing status), show stopped icon + Idle
    if [[ "$type" == "idle" || "$status" != "Playing" ]]; then
        echo "$ICON_IDLE Idle"
        return
    fi

    icon=$(get_status_icon "$status")
    title=$(format_title "$title" "$cutpoint")

    echo "$icon $title"
}

function cmd_get_active_player() {
    local active_info type
    active_info=$(get_active_player)
    IFS='|' read -r type _ _ <<< "$active_info"
    echo "$type"
}

function cmd_play_pause() {
    send_control play-pause
}

function cmd_next() {
    send_control next
}

function cmd_previous() {
    send_control previous
}

# ============================================================================
# HELP & VERSION
# ============================================================================

function show_help() {
    cat << EOF
$SCRIPT_NAME v$VERSION - Unified media player controller

USAGE:
    $SCRIPT_NAME <command> [options]

COMMANDS:
    status              Get full state (type|player|status|title|artist|album|art_url)
    title [cutpoint]    Get formatted title (default cutpoint: 50)
    state               Get status icon only
    state-title [cut]   Get icon + title
    get-active-player   Get active source type (browser|song|idle)

    play-pause          Toggle playback
    next                Next track
    previous            Previous track

    help                Show this help message
    version             Show version

EXAMPLES:
    $SCRIPT_NAME status
    $SCRIPT_NAME state-title 30
    $SCRIPT_NAME play-pause

PRIORITY LOGIC:
    Only shows players that are actively Playing
    Browser players take priority over song players
    Shows Idle if nothing is Playing (ignores paused/stopped)

SIGNALS:
    Send SIGRTMIN+21 or SIGRTMIN+22 to trigger status bar updates
    (configure in your status bar: pkill -RTMIN+21 dwmblocks)

EOF
}

function show_version() {
    echo "$SCRIPT_NAME v$VERSION"
}

# ============================================================================
# MAIN
# ============================================================================

function main() {
    check_dependencies
    init_cache_dir

    local command="${1:-help}"
    shift || true

    case "$command" in
        status)           cmd_status ;;
        title)            cmd_title "$@" ;;
        state)            cmd_state ;;
        state-title)      cmd_state_title "$@" ;;
        get-active-player) cmd_get_active_player ;;
        play-pause)       cmd_play_pause ;;
        next)             cmd_next ;;
        previous)         cmd_previous ;;
        help|--help|-h)   show_help ;;
        version|--version|-v) show_version ;;
        *)                die "Unknown command: $command (try '$SCRIPT_NAME help')" ;;
    esac
}

main "$@"
