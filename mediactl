#!/usr/bin/env bash
# mediactl - Unified media player controller
# Manages browser-based media and dedicated players with priority-based selection.

set -euo pipefail

# ============================================================================
# CONFIGURATION
# ============================================================================

readonly SCRIPT_NAME="mediactl"
readonly VERSION="1.3.0"

# Priority 1: Browsers (Usually video content)
readonly BROWSER_PLAYERS=(
    "firefox"
    "chromium"
    "chrome"
    "brave"
    "vivaldi"
    "plasma-browser-integration"
)

# Priority 2: Dedicated Music Apps
readonly SONG_PLAYERS=(
    "spotify"
    "SubsonicTUI"
    "Feishin"
    "Supersonic"
    "mpd"
    "mopidy"
    "elisa"
    "rhythmbox"
    "vlc"
)

readonly CACHE_DIR="${XDG_RUNTIME_DIR:-/tmp}/mediactl"
readonly PLAYER_LIST_CACHE="$CACHE_DIR/players"
readonly CACHE_LOCKFILE="$CACHE_DIR/players.lock"
readonly CACHE_LIFETIME=1  # seconds

# Custom Icons (Nerd Fonts recommended)
readonly ICON_BROWSER="󰖟"
readonly ICON_SONG=""
readonly ICON_PLAYING=" "
readonly ICON_PAUSED=" "
readonly ICON_STOPPED=" "
readonly ICON_IDLE=" "

# Command timeout (prevent hanging on unresponsive players)
readonly PLAYERCTL_TIMEOUT=3

SOURCE=""  # global source filter

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

function die() {
    echo "$SCRIPT_NAME: $*" >&2
    exit 1
}

function check_dependencies() {
    if ! command -v playerctl &>/dev/null; then
        die "playerctl not found. Install it to use $SCRIPT_NAME"
    fi
    if ! command -v flock &>/dev/null; then
        die "flock not found. Install util-linux to use $SCRIPT_NAME"
    fi
}

function init_cache_dir() {
    mkdir -p "$CACHE_DIR"
}

function is_cache_fresh() {
    local cache_file="$1"
    [[ -f "$cache_file" ]] || return 1

    local now mod_time age
    now=$(date +%s)
    mod_time=$(stat -c %Y "$cache_file" 2>/dev/null || echo 0)
    age=$((now - mod_time))

    [[ $age -lt $CACHE_LIFETIME ]]
}

# ============================================================================
# PLAYER DETECTION & CLASSIFICATION
# ============================================================================

function get_all_players() {
    # Check if cache is fresh
    if is_cache_fresh "$PLAYER_LIST_CACHE"; then
        cat "$PLAYER_LIST_CACHE" 2>/dev/null || echo ""
        return 0
    fi

    # Use file locking to prevent concurrent writes (e.g., polybar multiple modules)
    (
        if ! flock -w 2 200; then
            cat "$PLAYER_LIST_CACHE" 2>/dev/null || echo ""
            return 1
        fi

        if is_cache_fresh "$PLAYER_LIST_CACHE"; then
            cat "$PLAYER_LIST_CACHE"
            return 0
        fi

        local players
        if players=$(timeout "$PLAYERCTL_TIMEOUT" playerctl -l 2>/dev/null); then
            echo "$players" | tee "$PLAYER_LIST_CACHE"
        else
            echo ""
            return 1
        fi
    ) 200>"$CACHE_LOCKFILE"
}

function is_browser_player() {
    local player="$1"
    for bp in "${BROWSER_PLAYERS[@]}"; do
        [[ "$player" == *"$bp"* ]] && return 0
    done
    return 1
}

function is_song_player() {
    local player="$1"
    for sp in "${SONG_PLAYERS[@]}"; do
        [[ "$player" == *"$sp"* ]] && return 0
    done
    return 1
}

function get_player_status_safe() {
    local player="$1"
    timeout "$PLAYERCTL_TIMEOUT" playerctl -p "$player" status 2>/dev/null || echo "Stopped"
}

function get_players_by_type() {
    local type="$1"
    local all_players
    all_players=$(get_all_players)

    while IFS= read -r player; do
        [[ -z "$player" ]] && continue

        local match=0
        if [[ "$type" == "browser" ]] && is_browser_player "$player"; then match=1; fi
        if [[ "$type" == "song" ]] && is_song_player "$player"; then match=1; fi

        if [[ $match -eq 1 ]]; then
            local status
            status=$(get_player_status_safe "$player")
            echo "$player|$status"
        fi
    done <<< "$all_players"
}

# ============================================================================
# PRIORITY RESOLUTION
# ============================================================================

# Logic: Browser Playing > Song Playing > Browser Paused > Song Paused > Idle
function get_active_player() {
    local filter="${1:-}"
    local active_info

    # 1. Handle Explicit Filters
    if [[ "$filter" == "browser" ]]; then
        active_info=$(get_players_by_type "browser" | awk -F'|' '$2=="Playing" || $2=="Paused"{print "browser|"$1"|"$2; exit}')
        [[ -z "$active_info" ]] && active_info="idle||Idle"
        echo "$active_info"
        return
    fi

    if [[ "$filter" == "song" ]]; then
        active_info=$(get_players_by_type "song" | awk -F'|' '$2=="Playing" || $2=="Paused"{print "song|"$1"|"$2; exit}')
        [[ -z "$active_info" ]] && active_info="idle||Idle"
        echo "$active_info"
        return
    fi

    # 2. Priority: Something is PLAYING
    # Check Browser Playing
    active_info=$(get_players_by_type "browser" | awk -F'|' '$2=="Playing"{print "browser|"$1"|"$2; exit}')

    # Check Song Playing
    if [[ -z "$active_info" ]]; then
        active_info=$(get_players_by_type "song" | awk -F'|' '$2=="Playing"{print "song|"$1"|"$2; exit}')
    fi

    # 3. Priority: Fallback to PAUSED (so the bar doesn't go blank)
    if [[ -z "$active_info" ]]; then
        # Check Browser Paused
        active_info=$(get_players_by_type "browser" | awk -F'|' '$2=="Paused"{print "browser|"$1"|"$2; exit}')
    fi

    if [[ -z "$active_info" ]]; then
        # Check Song Paused
        active_info=$(get_players_by_type "song" | awk -F'|' '$2=="Paused"{print "song|"$1"|"$2; exit}')
    fi

    # 4. Default to Idle
    [[ -z "$active_info" ]] && active_info="idle||Idle"
    echo "$active_info"
}

# ============================================================================
# METADATA & STATE
# ============================================================================

function get_player_metadata() {
    local player="$1"
    [[ "$player" == "idle" ]] && { echo "Idle||||"; return 0; }

    local status title artist album art_url
    status=$(timeout "$PLAYERCTL_TIMEOUT" playerctl -p "$player" status 2>/dev/null || echo "Stopped")
    title=$(timeout "$PLAYERCTL_TIMEOUT" playerctl -p "$player" metadata title 2>/dev/null || echo "Unknown")
    artist=$(timeout "$PLAYERCTL_TIMEOUT" playerctl -p "$player" metadata artist 2>/dev/null || echo "Unknown")
    album=$(timeout "$PLAYERCTL_TIMEOUT" playerctl -p "$player" metadata album 2>/dev/null || echo "")
    art_url=$(timeout "$PLAYERCTL_TIMEOUT" playerctl -p "$player" metadata mpris:artUrl 2>/dev/null || echo "")

    echo "$status|$title|$artist|$album|$art_url"
}

function get_state() {
    local filter="${1:-}"
    local active_info type player status metadata
    active_info=$(get_active_player "$filter")
    IFS='|' read -r type player status <<< "$active_info"

    if [[ "$type" == "idle" ]]; then
        echo "idle||Idle|||"
        return
    fi

    metadata=$(get_player_metadata "$player")
    echo "$type|$player|$metadata"
}

function get_status_icon() {
    case "$1" in
        Playing) echo "$ICON_PLAYING" ;;
        Paused)  echo "$ICON_PAUSED" ;;
        Stopped) echo "$ICON_STOPPED" ;;
        Idle)    echo "$ICON_IDLE" ;;
        *)       echo "" ;;
    esac
}

function format_title() {
    local title="$1"
    local cutpoint="${2:-50}"
    [[ "$title" == "Unknown" || "$title" == "Idle" ]] && { echo "$title"; return; }
    if [[ ${#title} -gt $cutpoint ]]; then echo "${title:0:$cutpoint}…"; else echo "$title"; fi
}

# ============================================================================
# CONTROL & COMMANDS
# ============================================================================

function send_control() {
    local command="$1"
    shift
    local active_info type player status
    active_info=$(get_active_player "$SOURCE")
    IFS='|' read -r type player status <<< "$active_info"

    [[ "$type" == "idle" ]] && { echo "No active player." >&2; return 1; }

    timeout "$PLAYERCTL_TIMEOUT" playerctl -p "$player" "$command" "$@" 2>/dev/null
}

# Handles forward skipping (default +)
function cmd_skip() {
    local val="${1:-5}"
    # Strip any existing plus/minus to format correctly
    local clean_val="${val#[+-]}"

    if [[ "$val" == -* ]]; then
        send_control position "$clean_val-"
    else
        send_control position "$clean_val+"
    fi
}

# Handles backward skipping (always -)
function cmd_back() {
    local val="${1:-5}"
    local clean_val="${val#[+-]}"
    send_control position "$clean_val-"
}

function cmd_status() { get_state "$SOURCE"; }
function cmd_title() {
    local cutpoint="${1:-50}"
    local state title
    state=$(get_state "$SOURCE")
    IFS='|' read -r _ _ _ title _ _ _ <<< "$state"
    format_title "$title" "$cutpoint"
}
function cmd_state() {
    local state type status
    state=$(get_state "$SOURCE")
    IFS='|' read -r type _ status _ <<< "$state"
    [[ "$type" == "idle" ]] && { echo "$ICON_IDLE"; return; }
    get_status_icon "$status"
}
function cmd_state_title() {
    local cutpoint="${1:-50}"
    local state type status title icon
    state=$(get_state "$SOURCE")
    IFS='|' read -r type _ status title _ <<< "$state"
    [[ "$type" == "idle" ]] && { echo "$ICON_IDLE Idle"; return; }
    icon=$(get_status_icon "$status")
    title=$(format_title "$title" "$cutpoint")
    echo "$icon $title"
}

function cmd_play_pause() { send_control play-pause; }
function cmd_next()       { send_control next; }
function cmd_previous()   { send_control previous; }

# ============================================================================
# MAIN
# ============================================================================

function show_help() {
    cat << EOF
$SCRIPT_NAME v$VERSION
A unified media controller for browsers and music players.

USAGE:
    $SCRIPT_NAME [options] <command> [args]

OPTIONS:
    -s, --source <browser|song>    Force command to a specific player type.

INFORMATION COMMANDS:
    status                         Get raw pipe-separated player state.
    state                          Show only the status icon (Playing/Paused).
    title [limit]                  Show current title (default limit 50 chars).
    state-title [limit]            Show icon and title together.

CONTROL COMMANDS:
    play-pause                     Toggle playback.
    next                           Skip to next track.
    previous                       Return to previous track.
    skip [seconds]                 Seek forward (default 5s). Use - for backward.
    back [seconds]                 Seek backward (default 5s).

EXAMPLES:
    $SCRIPT_NAME skip 15            # Move forward 15 seconds
    $SCRIPT_NAME back               # Move backward 5 seconds
    $SCRIPT_NAME --source song next # Skip track only on music players
EOF
}

function main() {
    check_dependencies
    init_cache_dir

    if [[ $# -ge 2 ]] && [[ "$1" == "--source" || "$1" == "-s" ]]; then
        SOURCE="$2"
        shift 2
    fi

    local command="${1:-help}"
    shift || true

    case "$command" in
        status)            cmd_status ;;
        title)             cmd_title "$@" ;;
        state)             cmd_state ;;
        state-title)       cmd_state_title "$@" ;;
        play-pause)        cmd_play_pause ;;
        next)              cmd_next ;;
        previous)          cmd_previous ;;
        skip|forward)      cmd_skip "$@" ;;  # Forward/Skip
        back|rewind)       cmd_back "$@" ;;  # Back/Rewind
        help|--help|-h)    show_help ;;
        *)                 die "Unknown command: $command" ;;
    esac
}
