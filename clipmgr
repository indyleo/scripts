#!/usr/bin/env bash

# Clipboard Manager for dwm
# Stores clipboard history and allows selection via dmenu
# Multiline entries appear as single lines, truncated if long

CLIP_DIR="$HOME/.cache/clipboard"
MAX_CLIPS=50
CLIP_FILE="$CLIP_DIR/history"
PIN_FILE="$CLIP_DIR/pinned"
PROGNAME=$(basename "$0")

mkdir -p "$CLIP_DIR"
touch "$CLIP_FILE"
touch "$PIN_FILE"

function show_usage() {
    cat << EOF
Usage: $PROGNAME {daemon|select|pin|clear}

Commands:
  daemon   Run in background to monitor clipboard
  select   Show clipboard history menu (default)
  pin      Show menu to pin/unpin clipboard items
  clear    Clear clipboard history (keeps pinned items)

Description:
  A clipboard manager for dwm that stores clipboard history
  and allows selection via dmenu. Pinned items stay at the top.
EOF
}

# Add clipboard content to history
function add_clip() {
    local new_clip="$1"
    [[ -z "${new_clip// }" ]] && return

    local safe_clip
    safe_clip=$(echo "$new_clip" | sed ':a;N;$!ba;s/\n/\\n/g')

    # Skip if pinned
    if grep -Fxq "$safe_clip" "$PIN_FILE" 2>/dev/null; then
        return
    fi

    # Remove duplicates
    sed -i "\|^${safe_clip}$|d" "$CLIP_FILE" 2>/dev/null

    # Add to top
    echo "$safe_clip" | cat - "$CLIP_FILE" > "$CLIP_FILE.tmp"
    mv "$CLIP_FILE.tmp" "$CLIP_FILE"

    # Limit history size
    sed -i "$((MAX_CLIPS + 1)),\$d" "$CLIP_FILE"
}

# Monitor clipboard changes
function daemon() {
    local last_clip=""
    while true; do
        local current_clip
        current_clip=$(xclip -o -selection clipboard 2>/dev/null)
        if [[ -n "$current_clip" && "$current_clip" != "$last_clip" ]]; then
            add_clip "$current_clip"
            last_clip="$current_clip"
        fi
        sleep 0.5
    done
}

# Generate a single-line preview, truncated if too long
function preview_line() {
    local line="$1"
    local max_len=60
    line="${line//\\n/ }"
    if (( ${#line} > max_len )); then
        echo "${line:0:max_len}â€¦"
    else
        echo "$line"
    fi
}

# Show history menu
function select_clip() {
    local selection menu_items counter=1
    declare -a FULL_CONTENTS

    # Pinned items
    if [[ -s "$PIN_FILE" ]]; then
        while IFS= read -r line; do
            FULL_CONTENTS+=("$line")
            local preview
            preview=$(preview_line "$line")
            menu_items+="[P${counter}] $preview"$'\n'
            ((counter++))
        done < "$PIN_FILE"
    fi

    # History items
    counter=1
    if [[ -s "$CLIP_FILE" ]]; then
        while IFS= read -r line; do
            FULL_CONTENTS+=("$line")
            local preview
            preview=$(preview_line "$line")
            menu_items+="[${counter}] $preview"$'\n'
            ((counter++))
        done < "$CLIP_FILE"
    fi

    selection=$(echo -n "$menu_items" | dmenu -l 20 -p "Clipboard History:")

    if [[ -n "$selection" ]]; then
        local index content
        if [[ "$selection" =~ ^\[P([0-9]+)\] ]]; then
            index="${BASH_REMATCH[1]}"
            content="${FULL_CONTENTS[$((index-1))]}"
        elif [[ "$selection" =~ ^\[([0-9]+)\] ]]; then
            index="${BASH_REMATCH[1]}"
            # History items start after pinned items
            local pinned_count
            pinned_count=$(wc -l < "$PIN_FILE")
            content="${FULL_CONTENTS[$((pinned_count + index - 1))]}"
        fi
        # Copy full content to clipboard
        echo -n "$(echo -e "$content")" | xclip -selection clipboard
    fi
}

# Pin/unpin menu
function pin_menu() {
    local selection menu_items counter=1
    declare -a FULL_CONTENTS

    if [[ -s "$PIN_FILE" ]]; then
        menu_items="=== PINNED (select to unpin) ==="$'\n'
        while IFS= read -r line; do
            FULL_CONTENTS+=("$line")
            local preview
            preview=$(preview_line "$line")
            menu_items+="[P${counter}] $preview"$'\n'
            ((counter++))
        done < "$PIN_FILE"
        menu_items+=$'\n'
    fi

    if [[ -s "$CLIP_FILE" ]]; then
        menu_items+="=== HISTORY (select to pin) ==="$'\n'
        counter=1
        while IFS= read -r line; do
            FULL_CONTENTS+=("$line")
            local preview
            preview=$(preview_line "$line")
            menu_items+="[${counter}] $preview"$'\n'
            ((counter++))
        done < "$CLIP_FILE"
    fi

    selection=$(echo -n "$menu_items" | dmenu -l 20 -p "Pin/Unpin:")

    [[ -z "$selection" || "$selection" == "==="* ]] && return

    local index content safe_content
    if [[ "$selection" =~ ^\[P([0-9]+)\] ]]; then
        index="${BASH_REMATCH[1]}"
        content="${FULL_CONTENTS[$((index-1))]}"
        # Unpin
        safe_content=$(echo "$content" | sed ':a;N;$!ba;s/\n/\\n/g')
        sed -i "\|^${safe_content}$|d" "$PIN_FILE" 2>/dev/null
        add_clip "$content"
    elif [[ "$selection" =~ ^\[([0-9]+)\] ]]; then
        index="${BASH_REMATCH[1]}"
        local pinned_count
        pinned_count=$(wc -l < "$PIN_FILE")
        content="${FULL_CONTENTS[$((pinned_count + index - 1))]}"
        # Pin
        safe_content=$(echo "$content" | sed ':a;N;$!ba;s/\n/\\n/g')
        echo "$safe_content" >> "$PIN_FILE"
        sed -i "\|^${safe_content}$|d" "$CLIP_FILE" 2>/dev/null
    fi
}

function clear_history() {
    true > "$CLIP_FILE"
    echo "Clipboard history cleared (pinned items preserved)"
}

# Main
case "${1:-"help"}" in
    daemon) daemon ;;
    select) select_clip ;;
    pin) pin_menu ;;
    clear) clear_history ;;
    -h|--help|help) show_usage ;;
    *)
        echo "Error: Unknown command '$1'"
        show_usage
        exit 1
        ;;
esac

