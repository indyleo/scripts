#!/bin/bash
# calamity-wiki-search.sh

# Configuration
CACHE_DIR="$HOME/.cache/calamity-wiki"
CACHE_FILE="$CACHE_DIR/pages.txt"
CACHE_AGE_DAYS=7

# Create cache directory if it doesn't exist
mkdir -p "$CACHE_DIR"

# Function to check if cache is stale
is_cache_stale() {
    if [ ! -f "$CACHE_FILE" ]; then
        return 0
    fi

    local cache_time=$(stat -c %Y "$CACHE_FILE" 2>/dev/null || stat -f %m "$CACHE_FILE" 2>/dev/null)
    local current_time=$(date +%s)
    local age_seconds=$((current_time - cache_time))
    local max_age_seconds=$((CACHE_AGE_DAYS * 86400))

    [ $age_seconds -gt $max_age_seconds ]
}

# Function to update cache
update_cache() {
    echo "Updating cache..." >&2

    local continue=""
    > "$CACHE_FILE"

    while true; do
        local url="https://calamitymod.wiki.gg/api.php?action=query&list=allpages&aplimit=500&format=json$continue"
        local response=$(curl -s "$url")

        echo "$response" | jq -r '.query.allpages[].title' >> "$CACHE_FILE"

        continue=$(echo "$response" | jq -r '.continue.apcontinue // empty')
        if [ -z "$continue" ]; then
            break
        fi
        continue="&apcontinue=$continue"
    done

    echo "Cache updated with $(wc -l < "$CACHE_FILE") pages" >&2
}

# Function to open wiki page
open_page() {
    local page="$1"
    local page_url=$(echo "$page" | sed 's/ /_/g')
    xdg-open "https://calamitymod.wiki.gg/wiki/$page_url"
}

# Function to search wiki
search_wiki() {
    local query="$1"
    local encoded=$(echo "$query" | sed 's/ /+/g')
    xdg-open "https://calamitymod.wiki.gg/wiki/Special:Search?search=$encoded"
}

# Check if we should update cache
if is_cache_stale; then
    if ping -c 1 -W 1 8.8.8.8 &>/dev/null 2>&1; then
        update_cache
    else
        if [ ! -f "$CACHE_FILE" ]; then
            echo "Error: No cache available and no internet connection" >&2
            exit 1
        fi
    fi
fi

if [ ! -f "$CACHE_FILE" ] || [ ! -s "$CACHE_FILE" ]; then
    echo "Error: Cache is empty." >&2
    exit 1
fi

# Show rofi with search option as first item
selected=$(
    (echo "üîç Search Wiki..." && cat "$CACHE_FILE") | \
    rofi -dmenu -i -p "Calamity Wiki:" \
        -matching fuzzy
)

if [ -n "$selected" ]; then
    # Check if user selected the search option
    if [ "$selected" = "üîç Search Wiki..." ]; then
        # Open second rofi for custom search input
        query=$(echo "" | rofi -dmenu -p "Search Calamity Wiki:")
        if [ -n "$query" ]; then
            search_wiki "$query"
        fi
    else
        # User selected a page from list
        open_page "$selected"
    fi
fi
